---
author: Tom Chen
custom_css:
- learning-center/fdtd101
- learning-center/menu
- learning-center/home
custom_font: font2
description: This notebook demonstrates a focusing apodized grating coupler to vertically
  couple light in/out of photonic integrated circuits (PICs).
image:
  alt: Focusing Apodized Grating Coupler | Flexcompute
  path: /assets/tidy3d/examples/image/apodized_grating_feature_image.png
layout: learning-center/example-library
menu_config:
  collapsed: true
  selected: Example Library
metadata:
  category: Photonic Integrated Circuit Components
  enable_more_examples: true
  more_examples:
  - name: Waveguide crossing based on cosine tapers
    path: notebooks/WaveguideCrossing/
    thumbnail:
      description: Waveguide crossing based on cosine tapers
      image: /assets/tidy3d/examples/image/waveguide_crossing.png
  - name: Waveguide bragg gratings
    path: notebooks/BraggGratings/
    thumbnail:
      description: Waveguide bragg gratings
      image: /assets/tidy3d/examples/image/bragg_waveguide.png
  - name: Exceptional coupling for waveguide crosstalk reduction
    path: notebooks/ZeroCrossTalkTE/
    thumbnail:
      description: Exceptional coupling for waveguide crosstalk reduction
      image: /assets/tidy3d/examples/image/exceptional_coupling_te.png
  pagination:
    next:
      name: 1x4 MMI power splitter
      path: notebooks/MMI1x4/
    previous:
      name: Uniform grating coupler
      path: notebooks/GratingCoupler/
  type: example-library
page_title: Focusing apodized grating coupler
source_link: https:/docs.flexcompute.com/projects/tidy3d/en/latest/_sources/notebooks/FocusedApodGC.ipynb
tags:
- focusing
- apodized
- grating coupler
- photonic integrated circuits
- design
- parameter sweep
- adjoint
- Tidy3D
- FDTD
title: Focusing Apodized Grating Coupler | Flexcompute
---


<html lang="en">
<head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/assets/tidy3d/examples/css/example-notebook.css" rel="stylesheet"/><script>
(function() {
  function addWidgetsRenderer() {
    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var scriptElement = document.createElement('script');
    
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        
        var widgetRendererSrc = 'https://unpkg.com/@jupyter-js-widgets@*/dist/embed.js';
        
      }
    } catch(e) {}

    scriptElement.src = widgetRendererSrc;
    document.body.appendChild(scriptElement);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>





<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>

<script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
<script type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
    // do not load mermaidjs if not needed
    if (!diagrams.length) {
      return;
    }
    const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
    const parser = new DOMParser();

    mermaid.initialize({
      maxTextSize: 100000,
      maxEdges: 100000,
      startOnLoad: false,
      fontFamily: window
        .getComputedStyle(document.body)
        .getPropertyValue("--jp-ui-font-family"),
      theme: document.querySelector("body[data-jp-theme-light='true']")
        ? "default"
        : "dark",
    });

    let _nextMermaidId = 0;

    function makeMermaidImage(svg) {
      const img = document.createElement("img");
      const doc = parser.parseFromString(svg, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      const { maxWidth } = svgEl?.style || {};
      const firstTitle = doc.querySelector("title");
      const firstDesc = doc.querySelector("desc");

      img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
      if (maxWidth) {
        img.width = parseInt(maxWidth);
      }
      if (firstTitle) {
        img.setAttribute("alt", firstTitle.textContent);
      }
      if (firstDesc) {
        const caption = document.createElement("figcaption");
        caption.className = "sr-only";
        caption.textContent = firstDesc.textContent;
        return [img, caption];
      }
      return [img];
    }

    async function makeMermaidError(text) {
      let errorMessage = "";
      try {
        await mermaid.parse(text);
      } catch (err) {
        errorMessage = `${err}`;
      }

      const result = document.createElement("details");
      result.className = 'jp-RenderedMermaid-Details';
      const summary = document.createElement("summary");
      summary.className = 'jp-RenderedMermaid-Summary';
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerText = text;
      pre.appendChild(code);
      summary.appendChild(pre);
      result.appendChild(summary);

      const warning = document.createElement("pre");
      warning.innerText = errorMessage;
      result.appendChild(warning);
      return [result];
    }

    async function renderOneMarmaid(src) {
      const id = `jp-mermaid-${_nextMermaidId++}`;
      const parent = src.parentNode;
      let raw = src.textContent.trim();
      const el = document.createElement("div");
      el.style.visibility = "hidden";
      document.body.appendChild(el);
      let results = null;
      let output = null;
      try {
        let { svg } = await mermaid.render(id, raw, el);
        svg = cleanMermaidSvg(svg);
        results = makeMermaidImage(svg);
        output = document.createElement("figure");
        results.map(output.appendChild, output);
      } catch (err) {
        parent.classList.add("jp-mod-warning");
        results = await makeMermaidError(raw);
        output = results[0];
      } finally {
        el.remove();
      }
      parent.classList.add("jp-RenderedMermaid");
      parent.appendChild(output);
    }


    /**
     * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
     */
    function cleanMermaidSvg(svg) {
      return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
    }


    /**
     * A regular expression for all void elements, which may include attributes and
     * a slash.
     *
     * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
     *
     * Of these, only `<br>` is generated by Mermaid in place of `\n`,
     * but _any_ "malformed" tag will break the SVG rendering entirely.
     */
    const RE_VOID_ELEMENT =
      /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

    /**
     * Ensure a void element is closed with a slash, preserving any attributes.
     */
    function replaceVoidElement(match, tag, rest) {
      rest = rest.trim();
      if (!rest.endsWith('/')) {
        rest = `${rest} /`;
      }
      return `<${tag} ${rest}>`;
    }

    void Promise.all([...diagrams].map(renderOneMarmaid));
  });
</script>

</head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d35563e3-20e1-49e6-a9f9-a0a800ff4cbf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p><strong>Running the entire notebook costs more than 1 FlexCredit.</strong></p>
<p>In this notebook, we will design a focusing apodized grating coupler (GC) to vertically couple light in/out photonic integrated circuits (PICs). We will build the grating coupler following the design guidelines presented in the following paper: R. Marchetti, C. Lacava, A. Khokhar, et al. "High-efficiency grating-couplers: demonstration of a new design strategy," Sci Rep 7, 16670 (2017) <a href="https://doi.org/10.1038/s41598-017-16505-z" target="_blank">DOI: 10.1038/s41598-017-16505-z</a>. In a previous case study, we modeled an <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/GratingCoupler/" target="_blank">uniform grating coupler</a>. The apodized grating coupler demonstrated in this notebook shows superior performance.</p>
<p>For more integrated photonic examples such as the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/8ChannelDemultiplexer/" target="_blank">8-Channel mode and polarization de-multiplexer</a>, the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/BilevelPSR/" target="_blank">broadband bi-level taper polarization rotator-splitter</a>, and the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/BroadbandDirectionalCoupler/" target="_blank">broadband directional coupler</a>, please visit our <a href="https://www.flexcompute.com/tidy3d/examples/" target="_blank">examples page</a>.</p>
<p>If you are new to the finite-difference time-domain (FDTD) method, we highly recommend going through our <a href="https://www.flexcompute.com/tidy3d/learning-center/" target="_blank">FDTD101</a> tutorials.</p>
<p>FDTD simulations can diverge due to various reasons. If you run into any simulation divergence issues, please follow the steps outlined in our <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/DivergedFDTDSimulation/" target="_blank">troubleshooting guide</a> to resolve it.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=85959919-a2e6-48b1-996b-bc0f695c0a64">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Standard python imports.</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">gdstk</span>

<span class="c1"># Import regular tidy3d.</span>
<span class="kn">import</span> <span class="nn">tidy3d</span> <span class="k">as</span> <span class="nn">td</span>
<span class="kn">import</span> <span class="nn">tidy3d.web</span> <span class="k">as</span> <span class="nn">web</span>
<span class="kn">from</span> <span class="nn">tidy3d.plugins</span> <span class="kn">import</span> <span class="n">waveguide</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=1dcf897e-3de2-4a21-a55c-3a55c452924c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Grating-Coupler-Structure">Grating Coupler Structure<a class="anchor-link" href="#Grating-Coupler-Structure">¶</a></h2><p>The GC structure is based on a standard silicon-on-insulator (SOI) wafer with a device layer of 220 nm. By linearly varying the fill-factor $F(x) = F_{0} - R\cdot x$, where $F_{0}$ is the fill-factor of the first grating element and $R$ is the apodization factor, the power radiated by the first elements of the grating is reduced, and the mode matching between the output waveguide and the grating section is improved, thus reducing reflections. To further improve the grating coupling efficiency, the grating element size $\Delta$ is let to vary, so satisfying the Bragg condition along the whole grating.</p>
<center><img alt="Focused Apodized Grating Coupler" src="/assets/tidy3d/examples/image/FocusedGC.png" width="700"/></center>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=bfd39560">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>The effective index of a grating element $n_{eff}(x)$ then depends on the fill-factor $F(x)$, and the mode indices obtained in the etched ($n_{e}$) and non-etched ($n_{o}$) sections of the grating, as</p>
<p>\begin{equation*}
n_{eff}(x) = F(x)n_{o} + [1 - F(x)]n_{e}.
\tag{1}
\end{equation*}</p>
<p>From the effective index, the size of each grating element can be calculated as:</p>
<p>\begin{equation*}
\Delta(x) = \frac{\lambda_{0}}{n_{e} - n_{c}sin(\theta_{gc}) + F(x)\Delta n}
\tag{2}
\end{equation*}</p>
<p>where $\lambda_{0}$ is the center wavelength, $n_{c}$ is the cladding refractive index, $\theta_{gc}$ is the light incidence angle with respect to the grating normal, and $\Delta n = n_{o} - n_{e}$.</p>
<p>A focusing design of GC is usually adopted to reduce device footprint. In this way, the grating lines (indicated by an integer $q$) are curved forming ellipses with common focal points, as in Eq. 3 (<code>Ralf Waldhäusl, Bernd Schnabel, Peter Dannberg, Ernst-Bernhard Kley, Andreas Bräuer, and Wolfgang Karthe, "Efficient Coupling into Polymer Waveguides by Gratings," Appl. Opt. 36, 9383-9390 (1997)</code><a href="https://doi.org/10.1364/AO.36.009383" target="_blank">DOI: 10.1364/AO.36.009383</a>).</p>
<p>\begin{equation*}
q\lambda_{0} = n_{eff}\sqrt{x^{2} + y^{2}} - xn_{c}sin(\theta_{f}).
\tag{3}
\end{equation*}</p>
<p>For simplicity, we will approximate the grating lines by concentric circles, which is a reasonable assumption considering small incidence angles.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d10bb29a-c05f-495f-8863-408e81cb165b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Grating coupler set up.</span>
<span class="n">h_dev</span> <span class="o">=</span> <span class="mf">0.220</span>  <span class="c1"># Device layer thickness (um).</span>
<span class="n">h_box</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># BOX layer thickness (um).</span>
<span class="n">h_clad</span> <span class="o">=</span> <span class="mf">0.78</span>  <span class="c1"># Cladding layer thickness (um).</span>
<span class="n">h_sub</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># Silicon substrate thickness (um).</span>
<span class="n">etch_d</span> <span class="o">=</span> <span class="mf">0.110</span>  <span class="c1"># GC etch depth (um).</span>
<span class="n">alpha_t</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># GC taper opening angle (degrees).</span>
<span class="n">tap_l</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># Taper length (um).</span>
<span class="n">tap_e</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Additional length after GC elements (um).</span>
<span class="n">n_p</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># Number of grating elements.</span>
<span class="n">r_i</span> <span class="o">=</span> <span class="mf">0.0275</span>  <span class="c1"># Initial value for the apodization parameter.</span>
<span class="n">min_feature</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Minimum feature size (um).</span>
<span class="n">spot_size</span> <span class="o">=</span> <span class="mf">10.4</span>  <span class="c1"># Single-mode fiber (SMF) spot-size (um).</span>
<span class="n">theta_f</span> <span class="o">=</span> <span class="mf">14.5</span>  <span class="c1"># Fiber tilt angle w.r.t the z-axis (degrees).</span>
<span class="n">src_pos</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Source position w.r.t the position of the first GC line (um).</span>
<span class="n">src_offset</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># Source offset w.r.t GC surface (um).</span>
<span class="n">wg_l</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Output waveguide length (um).</span>
<span class="n">wg_w</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Output waveguide width (um).</span>
<span class="n">gc_file</span> <span class="o">=</span> <span class="s2">"misc/Focusing_GC.gds"</span>  <span class="c1"># File name to export GC GDS file.</span>

<span class="c1"># Materials.</span>
<span class="n">n_si</span> <span class="o">=</span> <span class="mf">3.48</span>  <span class="c1"># Silicon refractive index.</span>
<span class="n">n_sio2</span> <span class="o">=</span> <span class="mf">1.44</span>  <span class="c1"># SiO2 refractive index.</span>
<span class="n">n_c</span> <span class="o">=</span> <span class="mf">1.44</span>  <span class="c1"># Cladding refractive index.</span>

<span class="c1"># Simulation set up.</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mf">1.55</span>  <span class="c1"># Center simulation wavelength (um).</span>
<span class="n">bw</span> <span class="o">=</span> <span class="mf">0.06</span>  <span class="c1"># Simulation wavelength bandwidth (um).</span>
<span class="n">n_wl</span> <span class="o">=</span> <span class="mi">61</span>  <span class="c1"># Number of wavelength points in monitors.</span>
<span class="n">run_time</span> <span class="o">=</span> <span class="mf">2e-12</span>  <span class="c1"># Run time parameter for simulation (s).</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f2c7a394-c088-4709-97f1-77e52acaf240">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>We will calculate and define some parameters used throughout the notebook.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f56c5263-0fec-4c23-a20a-bd9d69cc39c4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Material definitions.</span>
<span class="n">mat_si</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_si</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Waveguide material.</span>
<span class="n">mat_sio2</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_sio2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># BOX material.</span>
<span class="n">mat_clad</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Cladding material.</span>

<span class="c1"># Light incidence angle on the GC.</span>
<span class="n">theta_gc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<span class="c1"># Wavelengths and frequencies.</span>
<span class="n">wl_max</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">wl_min</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">-</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">wl_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">wl_min</span><span class="p">,</span> <span class="n">wl_max</span><span class="p">,</span> <span class="n">n_wl</span><span class="p">)</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">C_0</span> <span class="o">/</span> <span class="n">wl</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">C_0</span> <span class="o">/</span> <span class="n">wl_range</span>
<span class="n">freqw</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ad6a2efa-4b43-463b-9904-c0b17cb4c7c3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>So, let's define some functions to create the grating coupler.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6c614860-73d4-4a2a-83c0-f081093461ae">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Function to calculate the values of filling fractions and grating element sizes.</span>
<span class="k">def</span> <span class="nf">calc_gc_par</span><span class="p">(</span>
    <span class="n">no</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.65</span><span class="p">,</span>
    <span class="n">ne</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.25</span><span class="p">,</span>
    <span class="n">nc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">lamb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.55</span><span class="p">,</span>
    <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
    <span class="n">R</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span>
    <span class="n">min_feature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.140</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">del_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">))</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">))</span>
    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="n">del_0</span> <span class="o">=</span> <span class="n">lamb</span> <span class="o">/</span> <span class="p">(</span><span class="n">no</span> <span class="o">-</span> <span class="n">nc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">))</span>
    <span class="n">f_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">del_0</span> <span class="o">-</span> <span class="n">min_feature</span><span class="p">)</span> <span class="o">/</span> <span class="n">del_0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">f_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_0</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">del_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamb</span> <span class="o">/</span> <span class="p">(</span><span class="n">ne</span> <span class="o">-</span> <span class="n">nc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">f_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">no</span> <span class="o">-</span> <span class="n">ne</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">del_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">del_x</span><span class="p">,</span> <span class="n">f_x</span><span class="p">)</span>


<span class="c1"># Function to create the 3D GC structure.</span>
<span class="k">def</span> <span class="nf">build_gc</span><span class="p">(</span>
    <span class="n">del_x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">f_x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">40.0</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">wg_w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.50</span><span class="p">,</span>
    <span class="n">wg_t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.22</span><span class="p">,</span>
    <span class="n">wg_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">gds_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">[],</span>
<span class="p">):</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
    <span class="n">gc_cell</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">"GC"</span><span class="p">)</span>

    <span class="n">alpha_rad</span> <span class="o">=</span> <span class="n">alpha_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="n">xf</span> <span class="o">=</span> <span class="n">wg_l</span> <span class="o">-</span> <span class="p">((</span><span class="n">wg_w</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">yf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tap_l</span>
    <span class="c1"># GC taper section.</span>
    <span class="n">gc_slice</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">),</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">initial_angle</span><span class="o">=-</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">final_angle</span><span class="o">=</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">datatype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gc_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gc_slice</span><span class="p">)</span>
    <span class="c1"># GC lines.</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">del_x</span><span class="p">,</span> <span class="n">f_x</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">d</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">f</span> <span class="o">*</span> <span class="n">d</span>
        <span class="n">gc_line</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
            <span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">),</span>
            <span class="n">r</span><span class="p">,</span>
            <span class="n">inner_radius</span><span class="o">=</span><span class="n">ri</span><span class="p">,</span>
            <span class="n">initial_angle</span><span class="o">=-</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">final_angle</span><span class="o">=</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">datatype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gc_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gc_line</span><span class="p">)</span>
    <span class="c1"># GC extension.</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">r</span> <span class="o">+=</span> <span class="n">tap_e</span>
    <span class="n">gc_ext</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">),</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">inner_radius</span><span class="o">=</span><span class="n">ri</span><span class="p">,</span>
        <span class="n">initial_angle</span><span class="o">=-</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">final_angle</span><span class="o">=</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">datatype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gc_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gc_ext</span><span class="p">)</span>
    <span class="c1"># GC non-etched material.</span>
    <span class="n">gc_full_slice</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">),</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">initial_angle</span><span class="o">=-</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">final_angle</span><span class="o">=</span><span class="n">alpha_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">datatype</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gc_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gc_full_slice</span><span class="p">)</span>
    <span class="c1"># Input/output waveguide.</span>
    <span class="n">wg_v</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">wg_l</span><span class="p">,</span> <span class="o">-</span><span class="n">wg_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">wg_l</span><span class="p">,</span> <span class="o">-</span><span class="n">wg_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">wg_l</span><span class="p">,</span> <span class="o">+</span><span class="n">wg_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">wg_l</span><span class="p">,</span> <span class="o">+</span><span class="n">wg_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">gc_wg</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">wg_v</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gc_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gc_wg</span><span class="p">)</span>

    <span class="c1"># Build the Tidy3D PolySlab and Structure objects.</span>
    <span class="n">gc_etch</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="o">.</span><span class="n">from_gds</span><span class="p">(</span>
        <span class="n">gc_cell</span><span class="p">,</span> <span class="n">gds_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">etch_d</span><span class="p">,</span> <span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">gc_non_etch</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="o">.</span><span class="n">from_gds</span><span class="p">(</span>
        <span class="n">gc_cell</span><span class="p">,</span> <span class="n">gds_layer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">etch_d</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wg</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="o">.</span><span class="n">from_gds</span><span class="p">(</span>
        <span class="n">gc_cell</span><span class="p">,</span> <span class="n">gds_layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wg_t</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gc_struct</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GeometryGroup</span><span class="p">(</span><span class="n">geometries</span><span class="o">=</span><span class="p">(</span><span class="n">gc_non_etch</span><span class="p">,</span> <span class="o">*</span><span class="n">gc_etch</span><span class="p">,</span> <span class="n">wg</span><span class="p">)),</span> <span class="n">medium</span><span class="o">=</span><span class="n">mat_si</span>
    <span class="p">)</span>

    <span class="c1"># Outputs the GDS file.</span>
    <span class="k">if</span> <span class="n">gds_file</span><span class="p">:</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">gds_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gc_struct</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8e65ea47">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Simulation-Set-Up">Simulation Set Up<a class="anchor-link" href="#Simulation-Set-Up">¶</a></h2><p>We will create a function to build different types of simulations based on the value of <code>sim_mode</code>:</p>
<ul>
<li><code>sim_mode = "sweep"</code>: <em>builds an in-coupling simulation using only one mode monitor.</em></li>
<li><code>sim_mode = "visualization"</code>: <em>builds an in-coupling simulation including field and flux monitors.</em></li>
<li><code>sim_mode = "out_coupling"</code>: <em>builds an out-coupling simulation using a field projection monitor.</em></li>
</ul>
<p>To define the grating structure, we will perform 2D simulations by running multiple parameter sweeps. Once this is completed, the final response will be obtained using 3D simulations. Details about setting up 2D simulations can be found in the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/RingResonator/" target="_blank">2D ring resonator notebook</a>.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1256637b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Function to create the simulation.</span>
<span class="k">def</span> <span class="nf">build_sim</span><span class="p">(</span>
    <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"sweep"</span><span class="p">,</span>
    <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"3D"</span><span class="p">,</span>
    <span class="n">no</span><span class="o">=</span><span class="mf">2.65</span><span class="p">,</span>
    <span class="n">ne</span><span class="o">=</span><span class="mf">2.25</span><span class="p">,</span>
    <span class="n">nc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">src_pos</span><span class="o">=</span><span class="n">src_pos</span><span class="p">,</span>
    <span class="n">R</span><span class="o">=</span><span class="n">r_i</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="o">=</span><span class="n">etch_d</span><span class="p">,</span>
    <span class="n">gds_file</span><span class="o">=</span><span class="p">[],</span>
<span class="p">):</span>
    <span class="c1"># Calculates the GC element sizes and fill-factors.</span>
    <span class="n">del_x</span><span class="p">,</span> <span class="n">f_x</span> <span class="o">=</span> <span class="n">calc_gc_par</span><span class="p">(</span>
        <span class="n">no</span><span class="o">=</span><span class="n">no</span><span class="p">,</span>
        <span class="n">ne</span><span class="o">=</span><span class="n">ne</span><span class="p">,</span>
        <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span>
        <span class="n">theta</span><span class="o">=</span><span class="n">theta_gc</span><span class="p">,</span>
        <span class="n">lamb</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span>
        <span class="n">N</span><span class="o">=</span><span class="n">n_p</span><span class="p">,</span>
        <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span>
        <span class="n">min_feature</span><span class="o">=</span><span class="n">min_feature</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># GC related parameters.</span>
    <span class="n">gc_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">wg_w</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">gc_0</span> <span class="o">=</span> <span class="n">wg_l</span> <span class="o">+</span> <span class="n">tap_l</span> <span class="o">-</span> <span class="n">gc_offset</span>
    <span class="n">gc_length</span> <span class="o">=</span> <span class="n">tap_l</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">del_x</span><span class="p">)</span> <span class="o">+</span> <span class="n">tap_e</span> <span class="o">-</span> <span class="n">gc_offset</span>
    <span class="n">pml_offset</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">wl</span>
    <span class="c1"># Simulation size.</span>
    <span class="n">size_z</span> <span class="o">=</span> <span class="n">h_sub</span> <span class="o">+</span> <span class="n">h_box</span> <span class="o">+</span> <span class="n">h_dev</span> <span class="o">+</span> <span class="n">h_clad</span> <span class="o">+</span> <span class="n">pml_offset</span>
    <span class="n">size_x</span> <span class="o">=</span> <span class="n">wg_l</span> <span class="o">+</span> <span class="n">gc_length</span> <span class="o">+</span> <span class="n">wl</span>
    <span class="n">size_y</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">gc_length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">alpha_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="k">if</span> <span class="n">sim_dim</span> <span class="o">==</span> <span class="s2">"3D"</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">center_z</span> <span class="o">=</span> <span class="n">size_z</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">pml_offset</span> <span class="o">-</span> <span class="n">h_clad</span> <span class="o">-</span> <span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Build the GC structure.</span>
    <span class="n">gc_struct</span> <span class="o">=</span> <span class="n">build_gc</span><span class="p">(</span>
        <span class="n">del_x</span><span class="o">=</span><span class="n">del_x</span><span class="p">,</span>
        <span class="n">f_x</span><span class="o">=</span><span class="n">f_x</span><span class="p">,</span>
        <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
        <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
        <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
        <span class="n">etch_d</span><span class="o">=</span><span class="n">etch_d</span><span class="p">,</span>
        <span class="n">wg_w</span><span class="o">=</span><span class="n">wg_w</span><span class="p">,</span>
        <span class="n">wg_t</span><span class="o">=</span><span class="n">h_dev</span><span class="p">,</span>
        <span class="n">wg_l</span><span class="o">=</span><span class="n">wg_l</span><span class="p">,</span>
        <span class="n">gds_file</span><span class="o">=</span><span class="n">gds_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Box layer.</span>
    <span class="n">_inf</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">sio2_box</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
            <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">h_box</span><span class="p">),</span> <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="n">_inf</span><span class="p">,</span> <span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">medium</span><span class="o">=</span><span class="n">mat_sio2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Cladding layer.</span>
    <span class="n">cladding</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
            <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="n">_inf</span><span class="p">,</span> <span class="n">_inf</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">h_clad</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">medium</span><span class="o">=</span><span class="n">mat_clad</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Substrate.</span>
    <span class="n">si_sub</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
            <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">_inf</span><span class="p">),</span> <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="n">_inf</span><span class="p">,</span> <span class="n">_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">h_box</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">medium</span><span class="o">=</span><span class="n">mat_si</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sim_mode</span> <span class="o">==</span> <span class="s2">"sweep"</span> <span class="ow">or</span> <span class="n">sim_mode</span> <span class="o">==</span> <span class="s2">"visualization"</span><span class="p">:</span>
        <span class="c1"># Gaussian source focused above the grating coupler.</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">GaussianBeam</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">gc_0</span> <span class="o">+</span> <span class="n">src_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">h_clad</span> <span class="o">+</span> <span class="n">src_offset</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span>
                <span class="mf">1.2</span> <span class="o">*</span> <span class="n">spot_size</span><span class="p">,</span>
                <span class="mf">1.2</span> <span class="o">*</span> <span class="n">spot_size</span>
                <span class="k">if</span> <span class="n">sim_dim</span> <span class="o">==</span> <span class="s2">"3D"</span>
                <span class="k">else</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>  <span class="c1"># Make it infinity in 2D.</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">source_time</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GaussianPulse</span><span class="p">(</span><span class="n">freq0</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">fwidth</span><span class="o">=</span><span class="n">freqw</span><span class="p">),</span>
            <span class="n">pol_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">angle_theta</span><span class="o">=</span><span class="n">theta_f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">"-"</span><span class="p">,</span>
            <span class="n">num_freqs</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">waist_radius</span><span class="o">=</span><span class="n">spot_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Mode monitor.</span>
        <span class="n">mode_spec</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSpec</span><span class="p">(</span><span class="n">num_modes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_neff</span><span class="o">=</span><span class="n">n_si</span><span class="p">)</span>
        <span class="n">mode_monitor</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeMonitor</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">wg_w</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">h_dev</span><span class="p">],</span>
            <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
            <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"mode_monitor"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_monitor</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sim_mode</span> <span class="o">==</span> <span class="s2">"visualization"</span><span class="p">:</span>
            <span class="c1"># Add field and flux monitors.</span>
            <span class="n">field_monitor_xy</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">etch_d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"field_xy"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_monitor_xy</span><span class="p">)</span>
            <span class="n">field_monitor_xz</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"field_xz"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_monitor_xz</span><span class="p">)</span>
            <span class="n">flux_sub</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FluxMonitor</span><span class="p">(</span>
                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">h_dev</span> <span class="o">-</span> <span class="n">h_box</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"flux_sub"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_sub</span><span class="p">)</span>
            <span class="n">flux_ref</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FluxMonitor</span><span class="p">(</span>
                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">+</span> <span class="n">h_clad</span> <span class="o">+</span> <span class="n">src_offset</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"flux_reflected"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_ref</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Define a mode source that injects te fundamental mode.</span>
        <span class="n">mode_spec</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSpec</span><span class="p">(</span><span class="n">num_modes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_neff</span><span class="o">=</span><span class="n">n_si</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSource</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">wg_w</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">h_dev</span><span class="p">),</span>
            <span class="n">source_time</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GaussianPulse</span><span class="p">(</span><span class="n">freq0</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">fwidth</span><span class="o">=</span><span class="n">freqw</span><span class="p">),</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span>
            <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
            <span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">num_freqs</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add a near field monitor.</span>
        <span class="n">field_monitor_xy</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">h_clad</span> <span class="o">+</span> <span class="n">src_offset</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"near_field"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_monitor_xy</span><span class="p">]</span>
        <span class="n">field_monitor_xz</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
            <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"field_xz"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_monitor_xz</span><span class="p">)</span>
        <span class="n">flux_back</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FluxMonitor</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
            <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"flux_back"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_back</span><span class="p">)</span>

    <span class="c1"># Refine the grid over the GC region.</span>
    <span class="n">refine_box</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">MeshOverrideStructure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">h_dev</span><span class="p">)),</span>
        <span class="n">dl</span><span class="o">=</span><span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span> <span class="k">if</span> <span class="n">sim_dim</span> <span class="o">==</span> <span class="s2">"3D"</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Simulation</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span>
        <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">center_z</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">size_z</span><span class="p">),</span>
        <span class="n">grid_spec</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GridSpec</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span>
            <span class="n">min_steps_per_wvl</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">override_structures</span><span class="o">=</span><span class="p">[</span><span class="n">refine_box</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">structures</span><span class="o">=</span><span class="p">[</span><span class="n">si_sub</span><span class="p">,</span> <span class="n">sio2_box</span><span class="p">,</span> <span class="n">cladding</span><span class="p">,</span> <span class="n">gc_struct</span><span class="p">],</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">source</span><span class="p">],</span>
        <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">,</span>
        <span class="n">boundary_spec</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">BoundarySpec</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Boundary</span><span class="o">.</span><span class="n">pml</span><span class="p">(),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Boundary</span><span class="o">.</span><span class="n">pml</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sim_dim</span> <span class="o">==</span> <span class="s2">"3D"</span>
            <span class="k">else</span> <span class="n">td</span><span class="o">.</span><span class="n">Boundary</span><span class="o">.</span><span class="n">periodic</span><span class="p">(),</span>  <span class="c1"># Make it periodic in 2D.</span>
            <span class="n">z</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Boundary</span><span class="o">.</span><span class="n">pml</span><span class="p">(),</span>
        <span class="p">),</span>
        <span class="n">symmetry</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sim_dim</span> <span class="o">==</span> <span class="s2">"3D"</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">run_time</span><span class="o">=</span><span class="n">run_time</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sim</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c0b3d96f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Grating-Coupler-Visualization">Grating Coupler Visualization<a class="anchor-link" href="#Grating-Coupler-Visualization">¶</a></h3><p>To verify if everything is correct, we will obtain the parameters $n_{o}$ and $n_{e}$, calculated using the <code>waveguide</code> plugin, and then visualize the grating coupler structure.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=39db5fa4-71f0-4af0-85ad-7bb678e6ff9d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Definition of wide non-etched and etched waveguides.</span>
<span class="n">wg_non_etch</span><span class="p">,</span> <span class="n">wg_etch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">waveguide</span><span class="o">.</span><span class="n">RectangularDielectric</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span>
        <span class="n">core_width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">spot_size</span><span class="p">,</span>
        <span class="n">core_thickness</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">core_medium</span><span class="o">=</span><span class="n">mat_si</span><span class="p">,</span>
        <span class="n">box_medium</span><span class="o">=</span><span class="n">mat_sio2</span><span class="p">,</span>
        <span class="n">clad_medium</span><span class="o">=</span><span class="n">mat_clad</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">h_dev</span><span class="p">,</span> <span class="n">h_dev</span> <span class="o">-</span> <span class="n">etch_d</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># Take a look at the waveguide cross-sections.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wg_non_etch</span><span class="o">.</span><span class="n">plot_structures</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Non-etched"</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wg_etch</span><span class="o">.</span><span class="n">plot_structures</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Etched"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_2.png"/>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c7207809-6214-4668-8619-c9ddcd48411e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">n_o</span> <span class="o">=</span> <span class="n">wg_non_etch</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">n_e</span> <span class="o">=</span> <span class="n">wg_etch</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Non-etched waveguide effective index: </span><span class="si">{</span><span class="n">n_o</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Etched waveguide effective index: </span><span class="si">{</span><span class="n">n_e</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Take a look at the waveguide fields.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">wg_non_etch</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"Ey"</span><span class="p">,</span> <span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Non-etched"</span><span class="p">)</span>
<span class="n">wg_etch</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"Ey"</span><span class="p">,</span> <span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Etched"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Non-etched waveguide effective index: 2.854
Etched waveguide effective index: 2.276
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_3.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4a794cb7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Let's visualize both the 2D and 3D versions of the simulation.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5bedec4c-58ab-4845-bcf5-2ff27dde3668">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_3d</span> <span class="o">=</span> <span class="n">build_sim</span><span class="p">(</span>
    <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"sweep"</span><span class="p">,</span>
    <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"3D"</span><span class="p">,</span>
    <span class="n">no</span><span class="o">=</span><span class="n">n_o</span><span class="p">,</span>
    <span class="n">ne</span><span class="o">=</span><span class="n">n_e</span><span class="p">,</span>
    <span class="n">nc</span><span class="o">=</span><span class="n">n_c</span><span class="p">,</span>
    <span class="n">src_pos</span><span class="o">=</span><span class="n">src_pos</span><span class="p">,</span>
    <span class="n">R</span><span class="o">=</span><span class="n">r_i</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="o">=</span><span class="n">etch_d</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sim_2d</span> <span class="o">=</span> <span class="n">build_sim</span><span class="p">(</span>
    <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"sweep"</span><span class="p">,</span>
    <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"2D"</span><span class="p">,</span>
    <span class="n">no</span><span class="o">=</span><span class="n">n_o</span><span class="p">,</span>
    <span class="n">ne</span><span class="o">=</span><span class="n">n_e</span><span class="p">,</span>
    <span class="n">nc</span><span class="o">=</span><span class="n">n_c</span><span class="p">,</span>
    <span class="n">src_pos</span><span class="o">=</span><span class="n">src_pos</span><span class="p">,</span>
    <span class="n">R</span><span class="o">=</span><span class="n">r_i</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="o">=</span><span class="n">etch_d</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>
<span class="n">sim_3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">etch_d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"3D"</span><span class="p">)</span>
<span class="n">sim_2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"2D"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_4.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=347ef115">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Definition-of-Grating-Coupler-Structure">Definition of Grating Coupler Structure<a class="anchor-link" href="#Definition-of-Grating-Coupler-Structure">¶</a></h2><p>Now, we will vary the GC etch depth and the apodization parameter to maximize the coupling efficiency (CE). At each iteration, a source position sweep is performed to find the maximum CE, so totalizing <code>len(etch_d_vals)</code>$\times$<code>len(R_vals)</code>$\times$<code>len(src_pos_vals)</code> simulations.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=78eaadd6">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">etch_d_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">R_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">src_pos_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of simulations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">R_vals</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">src_pos_vals</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Number of simulations: 240
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a0de0f8f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>As expected, the effective index decays as the etch depth increases.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8d7ffa9b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[10]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">n_e_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">):</span>
    <span class="n">wg_e</span> <span class="o">=</span> <span class="n">waveguide</span><span class="o">.</span><span class="n">RectangularDielectric</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span>
        <span class="n">core_width</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">spot_size</span><span class="p">,</span>
        <span class="n">core_thickness</span><span class="o">=</span><span class="n">h_dev</span> <span class="o">-</span> <span class="n">ed</span><span class="p">,</span>
        <span class="n">core_medium</span><span class="o">=</span><span class="n">mat_si</span><span class="p">,</span>
        <span class="n">box_medium</span><span class="o">=</span><span class="n">mat_sio2</span><span class="p">,</span>
        <span class="n">clad_medium</span><span class="o">=</span><span class="n">mat_clad</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">n_e_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wg_e</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">,</span> <span class="n">n_e_vals</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Etch Depth ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Effective Index"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_5.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=352c883f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Next, we will build and run the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/ParameterScan/" target="_blank">parameter sweep</a> using <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.web.run_async.html" target="_blank">web.run_async</a>. Verbosity will be turned off to reduce the amount of output data.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a37dcbbf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_sweep</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sa">f</span><span class="s2">"sim_etch_d:</span><span class="si">{</span><span class="n">ed</span><span class="si">}</span><span class="s2">_R:</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">_src_pos:</span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2">"</span><span class="p">:</span> <span class="n">build_sim</span><span class="p">(</span>
        <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"sweep"</span><span class="p">,</span>
        <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"2D"</span><span class="p">,</span>
        <span class="n">no</span><span class="o">=</span><span class="n">n_o</span><span class="p">,</span>
        <span class="n">ne</span><span class="o">=</span><span class="n">ne</span><span class="p">,</span>
        <span class="n">nc</span><span class="o">=</span><span class="n">n_c</span><span class="p">,</span>
        <span class="n">src_pos</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
        <span class="n">R</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
        <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
        <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
        <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
        <span class="n">etch_d</span><span class="o">=</span><span class="n">ed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">ed</span><span class="p">,</span> <span class="n">ne</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">,</span> <span class="n">n_e_vals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">R_vals</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">src_pos_vals</span>
<span class="p">}</span>

<span class="n">batch_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">simulations</span><span class="o">=</span><span class="n">sim_sweep</span><span class="p">,</span> <span class="n">path_dir</span><span class="o">=</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[21:38:10] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: No connection: Retrying for </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">180</span><span style="color: #800000; text-decoration-color: #800000"> seconds.       </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">webapi.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py#56" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">56</span></a>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[21:39:24] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: No connection: Retrying for </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">180</span><span style="color: #800000; text-decoration-color: #800000"> seconds.       </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">webapi.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py#56" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">56</span></a>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[21:41:25] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: No connection: Retrying for </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">180</span><span style="color: #800000; text-decoration-color: #800000"> seconds.       </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">webapi.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/web/webapi.py#56" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">56</span></a>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d36e709d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>After completing batch simulation, we will calculate and analyze the data.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=390993d9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">ce_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">R_vals</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">etch_d_vals</span><span class="o">.</span><span class="n">size</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">src_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ce_vals</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R_vals</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src_pos_vals</span><span class="p">):</span>
            <span class="n">sim_data</span> <span class="o">=</span> <span class="n">batch_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">"sim_etch_d:</span><span class="si">{</span><span class="n">ed</span><span class="si">}</span><span class="s2">_R:</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">_src_pos:</span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
            <span class="n">mode_amps</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">"mode_monitor"</span><span class="p">]</span>
            <span class="n">coeffs_f</span> <span class="o">=</span> <span class="n">mode_amps</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"-"</span><span class="p">)</span>
            <span class="n">power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeffs_f</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">power_db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">power</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">ce_vals</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">power_db</span><span class="p">:</span>
                <span class="n">ce_vals</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_db</span>
                <span class="n">src_vals</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b8e28d20">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>A CE value of -1.9 dB is obtained for an etch depth of 0.09 $\mu m$, R = 0.031 $\mu^{-1}$, and the source positioned at 5 $\mu m$. The next figure shows the higher values of CE with respect to etch depth and R.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5c13f626">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[13]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">jr</span><span class="p">,</span> <span class="n">ke</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ce_vals</span> <span class="o">==</span> <span class="n">ce_vals</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">final_etch_d</span> <span class="o">=</span> <span class="n">etch_d_vals</span><span class="p">[</span><span class="n">ke</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">final_R</span> <span class="o">=</span> <span class="n">R_vals</span><span class="p">[</span><span class="n">jr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">final_src_pos</span> <span class="o">=</span> <span class="n">src_vals</span><span class="p">[</span><span class="n">jr</span><span class="p">,</span> <span class="n">ke</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ce_2d</span> <span class="o">=</span> <span class="n">ce_vals</span><span class="p">[</span><span class="n">jr</span><span class="p">,</span> <span class="n">ke</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Etch depth: </span><span class="si">{</span><span class="n">final_etch_d</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"R: </span><span class="si">{</span><span class="n">final_R</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Source position: </span><span class="si">{</span><span class="n">final_src_pos</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
    <span class="n">etch_d_vals</span><span class="p">,</span>
    <span class="n">R_vals</span><span class="p">,</span>
    <span class="n">ce_vals</span><span class="p">,</span>
    <span class="n">shading</span><span class="o">=</span><span class="s2">"nearest"</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">ce_vals</span><span class="p">),</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ce_vals</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">etch_d_vals</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">R_vals</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Maximum CE: </span><span class="si">{</span><span class="n">ce_2d</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> dB"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Etch Depth ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"R ($\mu m^{-1}$)"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Coupling Efficiency (dB)"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Etch depth: 0.090
R: 0.031
Source position: 5.000
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_6.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f603f516">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Final-Grating-Coupler-Response">Final Grating Coupler Response<a class="anchor-link" href="#Final-Grating-Coupler-Response">¶</a></h2><p>Based on the parameters obtained in the previous section, we will build a 3D GC structure and calculate its response. A GDS file with the final layout will be output to <code>gc_file</code>.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c9dbb957">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[14]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_3d</span> <span class="o">=</span> <span class="n">build_sim</span><span class="p">(</span>
    <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"visualization"</span><span class="p">,</span>
    <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"3D"</span><span class="p">,</span>
    <span class="n">no</span><span class="o">=</span><span class="n">n_o</span><span class="p">,</span>
    <span class="n">ne</span><span class="o">=</span><span class="n">n_e_vals</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span>
    <span class="n">nc</span><span class="o">=</span><span class="n">n_c</span><span class="p">,</span>
    <span class="n">src_pos</span><span class="o">=</span><span class="n">final_src_pos</span><span class="p">,</span>
    <span class="n">R</span><span class="o">=</span><span class="n">final_R</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="o">=</span><span class="n">final_etch_d</span><span class="p">,</span>
    <span class="n">gds_file</span><span class="o">=</span><span class="n">gc_file</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>
<span class="n">sim_3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">h_dev</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">etch_d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sim_3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>/tmp/ipykernel_27095/1460779670.py:20: DeprecationWarning: Conversion of an array with ndim &gt; 0 to a scalar is deprecated, and will error in future. Ensure you extract a single element from your array before performing this operation. (Deprecated NumPy 1.25.)
  del_x[i] = lamb / (ne - nc * np.sin(theta_rad) + f_x[i] * (no - ne))
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[21:51:28] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Default value for the field monitor          </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">monitor.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py#261" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">261</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'colocate'</span><span style="color: #800000; text-decoration-color: #800000"> setting has changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">. All field components will be colocated to the  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">grid boundaries. Set to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to get the raw fields </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">on the Yee grid instead.                              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Default value for the field monitor          </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">monitor.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py#261" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">261</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'colocate'</span><span style="color: #800000; text-decoration-color: #800000"> setting has changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">. All field components will be colocated to the  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">grid boundaries. Set to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to get the raw fields </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">on the Yee grid instead.                              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_7.png"/>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9eba2cb2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">sim_3d</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s2">"gc_in_coupling_3d"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sim_3d_in</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">"data/gc3d_in_data.hdf5"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a2b491b2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>The CE of the 3D GC is lower than the 2D GC version only by 0.2 dB. The larger source of loss is the transmitted power into the silicon substrate.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1b3231cf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[16]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Coupling Efficiency</span>
<span class="n">mode_amps</span> <span class="o">=</span> <span class="n">sim_3d_in</span><span class="p">[</span><span class="s2">"mode_monitor"</span><span class="p">]</span>
<span class="n">coeffs_f</span> <span class="o">=</span> <span class="n">mode_amps</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"-"</span><span class="p">)</span>
<span class="n">power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeffs_f</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">power_db</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
<span class="n">ce_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">power_db</span><span class="p">)</span>
<span class="c1"># Fluxes</span>
<span class="n">power_sub</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sim_3d_in</span><span class="p">[</span><span class="s2">"flux_sub"</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
<span class="n">power_ref</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sim_3d_in</span><span class="p">[</span><span class="s2">"flux_reflected"</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_range</span><span class="p">,</span> <span class="n">power_db</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"solid"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">wl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wl_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Power (dB)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Maximum CE: </span><span class="si">{</span><span class="n">ce_3d</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> dB"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_range</span><span class="p">,</span>
    <span class="n">power_sub</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">"solid"</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">"substrate"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">wl_range</span><span class="p">,</span>
    <span class="n">power_ref</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">"solid"</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">"reflected"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">wl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wl_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Power (W)"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_8.png"/>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8758df00">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sim_3d_in</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"field_xy"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s2">"abs"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sim_3d_in</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"field_xz"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s2">"abs"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_9.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d510fcc3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Out-coupling-Configuration">Out-coupling Configuration<a class="anchor-link" href="#Out-coupling-Configuration">¶</a></h3><p>After obtaining the in-coupling response, we will build the same GC structure using the out-coupling configuration and run a final simulation.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=743e27b1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[18]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_3d_o</span> <span class="o">=</span> <span class="n">build_sim</span><span class="p">(</span>
    <span class="n">sim_mode</span><span class="o">=</span><span class="s2">"out_coupling"</span><span class="p">,</span>
    <span class="n">sim_dim</span><span class="o">=</span><span class="s2">"3D"</span><span class="p">,</span>
    <span class="n">no</span><span class="o">=</span><span class="n">n_o</span><span class="p">,</span>
    <span class="n">ne</span><span class="o">=</span><span class="n">n_e_vals</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span>
    <span class="n">nc</span><span class="o">=</span><span class="n">n_c</span><span class="p">,</span>
    <span class="n">src_pos</span><span class="o">=</span><span class="n">final_src_pos</span><span class="p">,</span>
    <span class="n">R</span><span class="o">=</span><span class="n">final_R</span><span class="p">,</span>
    <span class="n">alpha_t</span><span class="o">=</span><span class="n">alpha_t</span><span class="p">,</span>
    <span class="n">tap_l</span><span class="o">=</span><span class="n">tap_l</span><span class="p">,</span>
    <span class="n">tap_e</span><span class="o">=</span><span class="n">tap_e</span><span class="p">,</span>
    <span class="n">etch_d</span><span class="o">=</span><span class="n">final_etch_d</span><span class="p">,</span>
    <span class="n">gds_file</span><span class="o">=</span><span class="n">gc_file</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">job</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">sim_3d_o</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s2">"gc_out_coupling_3d"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sim_3d_out</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">"data/gc3d_out_data.hdf5"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>/tmp/ipykernel_27095/1460779670.py:20: DeprecationWarning: Conversion of an array with ndim &gt; 0 to a scalar is deprecated, and will error in future. Ensure you extract a single element from your array before performing this operation. (Deprecated NumPy 1.25.)
  del_x[i] = lamb / (ne - nc * np.sin(theta_rad) + f_x[i] * (no - ne))
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[21:59:21] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Default value for the field monitor          </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">monitor.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py#261" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">261</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'colocate'</span><span style="color: #800000; text-decoration-color: #800000"> setting has changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">. All field components will be colocated to the  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">grid boundaries. Set to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to get the raw fields </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">on the Yee grid instead.                              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Default value for the field monitor          </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">monitor.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/monitor.py#261" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">261</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'colocate'</span><span style="color: #800000; text-decoration-color: #800000"> setting has changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">. All field components will be colocated to the  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">grid boundaries. Set to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to get the raw fields </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">on the Yee grid instead.                              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4d9fe4ff">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>First, let's visualize the field at the $xz$ plane and above the GC cladding layer. As one can see, most of the power is scattered upwards. This fact and the lower values of back reflections confirm the effectiveness of the apodization method in improving the GC efficiency.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d5d42937">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[19]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">power_back</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sim_3d_out</span><span class="p">[</span><span class="s2">"flux_back"</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sim_3d_out</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"field_xz"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s2">"abs"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"auto"</span><span class="p">)</span>
<span class="n">sim_3d_out</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"near_field"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="s2">"abs"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_range</span><span class="p">,</span> <span class="n">power_back</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"solid"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">wl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wl_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Power (W)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_10.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a90fa851">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Finally, we will use the Tidy3D’s FieldProjector to compute the angular dependence of the far field scattering based on the near field monitor. The same approach presented and detailed in the <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/GratingCoupler/" target="_blank">uniform grating coupler notebook</a> is used here.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4b930759">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[20]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Creates a range of angles to probe.</span>
<span class="n">num_angles</span> <span class="o">=</span> <span class="mi">1101</span>
<span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_angles</span><span class="p">)</span>

<span class="c1"># Make a near-to-far monitor specifying the observation angles and frequencies of interest.</span>
<span class="n">monitor_n2f</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldProjectionAngleMonitor</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">sim_3d_o</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="n">sim_3d_o</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
    <span class="n">normal_dir</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">thetas</span><span class="p">,</span>
    <span class="n">phi</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"n2f"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Make a near field to far field projector with the near field monitor data</span>
<span class="n">near_field_surface</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldProjectionSurface</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="n">sim_3d_o</span><span class="o">.</span><span class="n">monitors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">normal_dir</span><span class="o">=</span><span class="s2">"+"</span>
<span class="p">)</span>
<span class="n">n2f</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldProjector</span><span class="p">(</span><span class="n">sim_data</span><span class="o">=</span><span class="n">sim_3d_out</span><span class="p">,</span> <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="n">near_field_surface</span><span class="p">])</span>

<span class="c1"># Compute the far_fields</span>
<span class="n">far_fields</span> <span class="o">=</span> <span class="n">n2f</span><span class="o">.</span><span class="n">project_fields</span><span class="p">(</span><span class="n">monitor_n2f</span><span class="p">)</span>

<span class="c1"># Compute the scattered cross section</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">far_fields</span><span class="o">.</span><span class="n">radar_cross_section</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[22:07:19] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Colocating data that has already been         </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/data/dataset.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">dataset.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-docs/tidy3d/tidy3d/components/data/dataset.py#79" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">79</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">colocated during the solver run. For most accurate     </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">results when colocating to custom coordinates set      </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'Monitor.colocate'</span><span style="color: #800000; text-decoration-color: #800000"> to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to use the raw data on   </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">the Yee grid and avoid double interpolation. Note: the </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">default value was changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D version  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">.                                                 </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">             </span>
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jupyter-widgets jp-OutputArea-output" id="f7a8496e-bf67-4b50-8397-c2b365891816" tabindex="0">
<script type="text/javascript">
var element = document.getElementById('f7a8496e-bf67-4b50-8397-c2b365891816');
</script>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a16025a1cdfd408fb2e06313aa6d6afc", "version_major": 2, "version_minor": 0}
</script>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=072502e8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>A remarkable agreement between the target angle and the GC emission angle is obtained.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=993c361b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[21]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># plot the angle dependence</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">"projection"</span><span class="p">:</span> <span class="s2">"polar"</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"simulated"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">[</span><span class="n">theta_f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">theta_f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s2">"r--"</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">"design angle"</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s2">"N"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Scattered Cross-section (arb. units)"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">"bottom"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/FocusedApodGC/FocusedApodGC_11.png"/>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {"131fd35c25174feba6ff71591cea9bd5": {"model_module": "@jupyter-widgets\/base", "model_module_version": "2.0.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets\/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets\/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "a16025a1cdfd408fb2e06313aa6d6afc": {"model_module": "@jupyter-widgets\/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets\/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets\/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_131fd35c25174feba6ff71591cea9bd5", "msg_id": "", "outputs": [{"data": {"text\/html": "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Processing surface monitor 'near_field'... <span style=\"color: #729c1f; text-decoration-color: #729c1f\">\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501<\/span> <span style=\"color: #800080; text-decoration-color: #800080\">100%<\/span> <span style=\"color: #008080; text-decoration-color: #008080\">0:00:00<\/span>\n<\/pre>\n", "text\/plain": "Processing surface monitor 'near_field'... \u001b[38;2;114;156;31m\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u001b[0m \u001b[35m100%\u001b[0m \u001b[36m0:00:00\u001b[0m\n"}, "metadata": {}, "output_type": "display_data"}], "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}
</script>
</html>
