---
author: Tom Chen
custom_css:
- learning-center/fdtd101
- learning-center/menu
- learning-center/home
custom_font: font2
description: This notebook demonstrates how to set up and run a simple parameterized
  level set-based optimization of a Y-branch. In this approach, we use jax to generate
  a level set surface given a set of design parameters. The permittivity distribution
  is then obtained from the zero level set isocontour. In addition, we show how to
  tailor the level set function to a starting geometry, which is helpful to further
  optimize a device obtained by conventional design.
layout: learning-center/example-library
menu_config:
  collapsed: true
  selected: Tidy3D Python
metadata:
  category: FDTD Adjoint Optimization
  enable_more_examples: false
  more_examples:
  - name: Inverse design optimization of a waveguide taper
    path: notebooks/AdjointPlugin5BoundaryGradients/
  - name: Adjoint-based shape optimization of a waveguide bend
    path: notebooks/AdjointPlugin8WaveguideBend/
  - name: Adjoint optimization of a wavelength division multiplexer
    path: notebooks/AdjointPlugin9WDM/
  pagination:
    next:
      name: Inverse design integrated with circuit simulation
      path: notebooks/AdjointPlugin11CircuitMZI/
    previous:
      name: Adjoint optimization of a wavelength division multiplexer
      path: notebooks/AdjointPlugin9WDM/
  type: python-tutorial
page_title: Parameterized level set optimization of a y-branch
source_link: https:/docs.flexcompute.com/projects/tidy3d/en/latest/_sources/notebooks/AdjointPlugin10YBranchLevelSet.ipynb
tags:
- inverse design
- level set
- y-branch
- photonic integrated circuits
- design optimization
- shape optimization
- adjoint
- Tidy3D
- FDTD
title: How to perform the inverse design of a y-branch using level set and the adjoint
  plugin in Tidy3D FDTD
---


<html lang="en">
<head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/assets/tidy3d/examples/css/example-notebook.css" rel="stylesheet"/>





<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>

<script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
<script type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
    // do not load mermaidjs if not needed
    if (!diagrams.length) {
      return;
    }
    const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
    const parser = new DOMParser();

    mermaid.initialize({
      maxTextSize: 100000,
      maxEdges: 100000,
      startOnLoad: false,
      fontFamily: window
        .getComputedStyle(document.body)
        .getPropertyValue("--jp-ui-font-family"),
      theme: document.querySelector("body[data-jp-theme-light='true']")
        ? "default"
        : "dark",
    });

    let _nextMermaidId = 0;

    function makeMermaidImage(svg) {
      const img = document.createElement("img");
      const doc = parser.parseFromString(svg, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      const { maxWidth } = svgEl?.style || {};
      const firstTitle = doc.querySelector("title");
      const firstDesc = doc.querySelector("desc");

      img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
      if (maxWidth) {
        img.width = parseInt(maxWidth);
      }
      if (firstTitle) {
        img.setAttribute("alt", firstTitle.textContent);
      }
      if (firstDesc) {
        const caption = document.createElement("figcaption");
        caption.className = "sr-only";
        caption.textContent = firstDesc.textContent;
        return [img, caption];
      }
      return [img];
    }

    async function makeMermaidError(text) {
      let errorMessage = "";
      try {
        await mermaid.parse(text);
      } catch (err) {
        errorMessage = `${err}`;
      }

      const result = document.createElement("details");
      result.className = 'jp-RenderedMermaid-Details';
      const summary = document.createElement("summary");
      summary.className = 'jp-RenderedMermaid-Summary';
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerText = text;
      pre.appendChild(code);
      summary.appendChild(pre);
      result.appendChild(summary);

      const warning = document.createElement("pre");
      warning.innerText = errorMessage;
      result.appendChild(warning);
      return [result];
    }

    async function renderOneMarmaid(src) {
      const id = `jp-mermaid-${_nextMermaidId++}`;
      const parent = src.parentNode;
      let raw = src.textContent.trim();
      const el = document.createElement("div");
      el.style.visibility = "hidden";
      document.body.appendChild(el);
      let results = null;
      let output = null;
      try {
        let { svg } = await mermaid.render(id, raw, el);
        svg = cleanMermaidSvg(svg);
        results = makeMermaidImage(svg);
        output = document.createElement("figure");
        results.map(output.appendChild, output);
      } catch (err) {
        parent.classList.add("jp-mod-warning");
        results = await makeMermaidError(raw);
        output = results[0];
      } finally {
        el.remove();
      }
      parent.classList.add("jp-RenderedMermaid");
      parent.appendChild(output);
    }


    /**
     * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
     */
    function cleanMermaidSvg(svg) {
      return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
    }


    /**
     * A regular expression for all void elements, which may include attributes and
     * a slash.
     *
     * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
     *
     * Of these, only `<br>` is generated by Mermaid in place of `\n`,
     * but _any_ "malformed" tag will break the SVG rendering entirely.
     */
    const RE_VOID_ELEMENT =
      /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

    /**
     * Ensure a void element is closed with a slash, preserving any attributes.
     */
    function replaceVoidElement(match, tag, rest) {
      rest = rest.trim();
      if (!rest.endsWith('/')) {
        rest = `${rest} /`;
      }
      return `<${tag} ${rest}>`;
    }

    void Promise.all([...diagrams].map(renderOneMarmaid));
  });
</script>

</head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<blockquote>
<p><strong>Note: the cost of running the entire notebook is higher than 1 FlexCredit.</strong></p>
</blockquote>
<p>This notebook demonstrates how to set up and run a parameterized level set-based optimization of a Y-branch. In this approach, we use <code>jax</code> to generate a level set surface $\phi(\rho)$ given a set of control knots $\rho$. The permittivity distribution is then obtained implicitly from the zero level set isocontour. Details about the level set method can be found <a href="https://doi.org/10.1016/S0045-7825(02)00559-5" target="_blank">here</a>. Minimum gap and curvature penalty terms are introduced in the optimization to control the minimum feature size, hence improving device fabrication. In addition, we show how to tailor the initial level set function to a starting geometry, which is helpful to further optimize a device obtained by conventional design.</p>
<p>You can also find some interesting adjoint functionalities for shape optimization in <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/AdjointPlugin5BoundaryGradients/" target="_blank">Inverse design optimization of a waveguide taper</a> and <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/AdjointPlugin8WaveguideBend/" target="_blank">Adjoint-based shape optimization of a waveguide bend</a>. If you are new to the finite-difference time-domain (FDTD) method, we highly recommend going through our <a href="https://www.flexcompute.com/tidy3d/learning-center/fdtd101/" target="_blank">FDTD101</a> tutorials. FDTD simulations can diverge due to various reasons. If you run into any simulation divergence issues, please follow the steps outlined in our <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/DivergedFDTDSimulation/" target="_blank">troubleshooting guide</a> to resolve it.</p>
<p><img alt="Y-branch Level Set Structure" src="/assets/tidy3d/examples/image/y_branch_level_set.png" width="600"/></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Let's start by importing the Python libraries used throughout this notebook.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Standard python imports.</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Import jax to be able to use automatic differentiation.</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">value_and_grad</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gdstk</span>

<span class="c1"># Import regular tidy3d.</span>
<span class="kn">import</span> <span class="nn">tidy3d</span> <span class="k">as</span> <span class="nn">td</span>
<span class="kn">import</span> <span class="nn">tidy3d.web</span> <span class="k">as</span> <span class="nn">web</span>

<span class="c1"># Import the components we need from the adjoint plugin.</span>
<span class="kn">import</span> <span class="nn">tidy3d.plugins.adjoint</span> <span class="k">as</span> <span class="nn">tda</span>
<span class="kn">from</span> <span class="nn">tidy3d.plugins.adjoint.web</span> <span class="kn">import</span> <span class="n">run</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'font.size'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'12'</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Y-branch-Inverse-Design-Configuration">Y-branch Inverse Design Configuration<a class="anchor-link" href="#Y-branch-Inverse-Design-Configuration">¶</a></h2><p>The y-branch splits the power from an input waveguide into two other output waveguides. Here, we are considering a gap of 0.3 $\mu m$ between the output waveguides for illustration purposes. However, when considering the design of a practical device, this value can be smaller. S-bends are included to keep the output waveguides apart from each other to prevent mode coupling.</p>
<p>Next, you can set the y-branch geometry and the inverse design parameters.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Geometric parameters.</span>
<span class="n">y_width</span> <span class="o">=</span> <span class="mf">1.7</span>  <span class="c1"># Y-branch maximum width (um).</span>
<span class="n">y_length</span> <span class="o">=</span> <span class="mf">1.7</span>  <span class="c1"># Y-branch maximum length (um).</span>
<span class="n">w_thick</span> <span class="o">=</span> <span class="mf">0.22</span>  <span class="c1"># Waveguide thickness (um).</span>
<span class="n">w_width</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Waveguide width (um).</span>
<span class="n">w_length</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Input output waveguide length (um).</span>
<span class="n">w_gap</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># Gap between the output waveguides (um).</span>
<span class="n">bend_length</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Output waveguide bend length (um).</span>
<span class="n">bend_offset</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Offset between output bends (um).</span>

<span class="c1"># Material.</span>
<span class="n">nSi</span> <span class="o">=</span> <span class="mf">3.48</span>  <span class="c1"># Silicon refractive index.</span>

<span class="c1"># Inverse design set up parameters.</span>
<span class="n">grid_size</span> <span class="o">=</span> <span class="mf">0.016</span>  <span class="c1"># Simulation grid size on design region (um).</span>
<span class="n">ls_grid_size</span> <span class="o">=</span> <span class="mf">0.004</span>  <span class="c1"># Discretization size of the level set function (um).</span>
<span class="n">ls_down_sample</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># The spacing between the level set control knots is given by ls_grid_size*ls_down_sample.</span>
<span class="n">fom_name_1</span> <span class="o">=</span> <span class="s2">"fom_field1"</span>  <span class="c1"># Name of the monitor used to compute the objective function.</span>
<span class="n">min_feature_size</span> <span class="o">=</span> <span class="mf">0.14</span>  <span class="c1"># Minimum fabrication feature size (um).</span>
<span class="n">gap_par</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Parameter to minimum gap fabrication constraint.</span>
<span class="n">curve_par</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Parameter of minimum curvature fabrication constraint.</span>

<span class="c1"># Optimizer parameters.</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Maximum number of iterations in optimization.</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.03</span>

<span class="c1"># Simulation wavelength.</span>
<span class="n">wl</span> <span class="o">=</span> <span class="mf">1.55</span>  <span class="c1"># Central simulation wavelength (um).</span>
<span class="n">bw</span> <span class="o">=</span> <span class="mf">0.06</span>  <span class="c1"># Simulation bandwidth (um).</span>
<span class="n">n_wl</span> <span class="o">=</span> <span class="mi">61</span>  <span class="c1"># Number of wavelength points within the bandwidth.</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>From the parameters defined before, a lot of variables are computed and used to set up the optimization.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Minimum and maximum values for the permittivities.</span>
<span class="n">eps_max</span> <span class="o">=</span> <span class="n">nSi</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">eps_min</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Material definition.</span>
<span class="n">mat_si</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">eps_max</span><span class="p">)</span>  <span class="c1"># Waveguide material.</span>

<span class="c1"># Wavelengths and frequencies.</span>
<span class="n">wl_max</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">wl_min</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">-</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">wl_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">wl_min</span><span class="p">,</span> <span class="n">wl_max</span><span class="p">,</span> <span class="n">n_wl</span><span class="p">)</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">C_0</span> <span class="o">/</span> <span class="n">wl</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">C_0</span> <span class="o">/</span> <span class="n">wl_range</span>
<span class="n">freqw</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">run_time</span> <span class="o">=</span> <span class="mf">5e-13</span>

<span class="c1"># Computational domain size.</span>
<span class="n">pml_spacing</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">wl</span>
<span class="n">size_x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">y_length</span> <span class="o">+</span> <span class="n">bend_length</span>
<span class="n">size_y</span> <span class="o">=</span> <span class="n">w_gap</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bend_offset</span> <span class="o">+</span> <span class="n">w_width</span> <span class="o">+</span> <span class="n">pml_spacing</span><span class="p">)</span>
<span class="n">size_z</span> <span class="o">=</span> <span class="n">w_thick</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pml_spacing</span>
<span class="n">eff_inf</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Source and monitor positions.</span>
<span class="n">mon_w</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">w_width</span>
<span class="n">mon_h</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">w_thick</span>

<span class="c1"># Separation between the level set control knots.</span>
<span class="n">rho_size</span> <span class="o">=</span> <span class="n">ls_down_sample</span> <span class="o">*</span> <span class="n">ls_grid_size</span>

<span class="c1"># Number of points on the parameter grid (rho) and level set grid (phi)</span>
<span class="n">nx_rho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_length</span> <span class="o">/</span> <span class="n">rho_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ny_rho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_width</span> <span class="o">/</span> <span class="n">rho_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">nx_phi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_length</span> <span class="o">/</span> <span class="n">ls_grid_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ny_phi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_width</span> <span class="o">/</span> <span class="n">ls_grid_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">npar</span> <span class="o">=</span> <span class="n">nx_rho</span> <span class="o">*</span> <span class="n">ny_rho</span>
<span class="n">ny_rho</span> <span class="o">*=</span> <span class="mi">2</span>
<span class="n">ny_phi</span> <span class="o">*=</span> <span class="mi">2</span>

<span class="c1"># Design region size</span>
<span class="n">dr_size_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx_phi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ls_grid_size</span>
<span class="n">dr_size_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny_phi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ls_grid_size</span>
<span class="n">dr_center_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># xy coordinates of the parameter and level set grids.</span>
<span class="n">x_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dr_center_x</span> <span class="o">-</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dr_center_x</span> <span class="o">+</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nx_rho</span><span class="p">)</span>
<span class="n">x_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dr_center_x</span> <span class="o">-</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dr_center_x</span> <span class="o">+</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nx_phi</span><span class="p">)</span>
<span class="n">y_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ny_rho</span><span class="p">)</span>
<span class="n">y_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ny_phi</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Level-Set-Functions">Level Set Functions<a class="anchor-link" href="#Level-Set-Functions">¶</a></h2><p>We are using <code>jax</code> to implement a parameterized level set function so the gradients can be back-propagated from the permittivity distribution defined by the zero level set isocontour to the design variables (the control knots of the level set surface). The space between the control knots and the Gaussian function width obtains some control over the minimum feature size. Other types of radial basis functions can also be used in replacement of the Gaussian one employed here, such as <a href="https://onlinelibrary.wiley.com/doi/10.1002/nme.1536" target="_blank">multiquadric splines</a> or <a href="https://opg.optica.org/oe/fulltext.cfm?uri=oe-28-5-7060&amp;id=427821" target="_blank">b-splines</a>.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LevelSetInterp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""This class implements the level set surface using Gaussian radial basis functions."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">y0</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">z0</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Input data.</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">xy0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy0</span> <span class="o">=</span> <span class="n">xy0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z0</span> <span class="o">=</span> <span class="n">z0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="c1"># Builds the level set interpolation model.</span>
        <span class="n">gauss_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">gauss_kernel</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyi</span><span class="p">,</span> <span class="n">xyj</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">xyi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">xyj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">xyi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">xyj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">dist</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_ls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
        <span class="n">xy1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">xx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">yy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy0</span><span class="p">,</span> <span class="n">xy1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="k">return</span> <span class="n">ls</span>


<span class="c1"># Function to plot the level set surface.</span>
<span class="k">def</span> <span class="nf">plot_level_set</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">azim</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">roll</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"RdBu"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                 <span class="n">zdir</span> <span class="o">=</span><span class="s1">'z'</span><span class="p">,</span>
                 <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">"k"</span><span class="p">,</span><span class="s2">"w"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">contour3D</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"binary"</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Level set surface"</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">'w'</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">'w'</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">zaxis</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">'w'</span><span class="p">)</span>
    
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>    
    <span class="n">ax2</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">phi</span><span class="p">)],</span> <span class="n">colors</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Zero level set contour"</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"equal"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>To map the permittivities to the zero-level set contour and obtain continuous derivatives, we use a hyperbolic tangent function as an approximation to a Heaviside function. Other smooth functions, such as sigmoid and arctangent, can also be employed. As discussed <a href="https://www.sciencedirect.com/science/article/pii/S0009250917303986" target="_blank">here</a>, the difference on computed interface using different functions will decrease when reducing the mesh size.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mirror_param</span><span class="p">(</span><span class="n">design_param</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">design_param</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nx_rho</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny_rho</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">param</span><span class="p">)),</span> <span class="n">param</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_eps</span><span class="p">(</span><span class="n">design_param</span><span class="p">,</span> <span class="n">sharpness</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">plot_levelset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Returns the permittivities defined by the zero level set isocontour"""</span>
    <span class="n">phi_model</span> <span class="o">=</span> <span class="n">LevelSetInterp</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x_rho</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y_rho</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">design_param</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">rho_size</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_model</span><span class="o">.</span><span class="n">get_ls</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">x_phi</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">y_phi</span><span class="p">)</span>

    <span class="c1"># Calculates the permittivities from the level set surface.</span>
    <span class="n">eps_phi</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">sharpness</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">eps_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">eps_max</span> <span class="o">-</span> <span class="n">eps_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps_phi</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">eps_min</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">)</span>

    <span class="c1"># Reshapes the design parameters into a 2D matrix.</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="p">(</span><span class="n">nx_phi</span><span class="p">,</span> <span class="n">ny_phi</span><span class="p">))</span>

    <span class="c1"># Plots the level set surface.</span>
    <span class="k">if</span> <span class="n">plot_levelset</span><span class="p">:</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">design_param</span><span class="p">,</span> <span class="p">(</span><span class="n">nx_rho</span><span class="p">,</span> <span class="n">ny_rho</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="p">(</span><span class="n">nx_phi</span><span class="p">,</span> <span class="n">ny_phi</span><span class="p">))</span>
        <span class="n">plot_level_set</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x_rho</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y_rho</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">x_phi</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">y_phi</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eps</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>In the next function, the permittivity values are used to build a <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxCustomMedium.html" target="_blank">JaxCustomMedium</a> within the design region.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">update_design</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">unfold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">tda</span><span class="o">.</span><span class="n">JaxStructure</span><span class="p">]:</span>
    <span class="c1"># Reflects the structure about the x-axis.</span>
    <span class="n">eps_val</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nx_phi</span><span class="p">,</span> <span class="n">ny_phi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">coords_x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dr_center_x</span> <span class="o">-</span> <span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ix</span> <span class="o">*</span> <span class="n">ls_grid_size</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx_phi</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">unfold</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Creation of a JaxCustomMedium using the values of the design parameters.</span>
        <span class="n">coords_yp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">ls_grid_size</span> <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ny_phi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))]</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coords_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coords_yp</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">])</span>
        <span class="n">eps_jax</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">"eps_</span><span class="si">{</span><span class="n">dim</span><span class="si">}{</span><span class="n">dim</span><span class="si">}</span><span class="s2">"</span><span class="p">:</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxDataArray</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">eps_val</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">ny_phi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="s2">"xyz"</span>
        <span class="p">}</span>
        <span class="n">eps_dataset</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxPermittivityDataset</span><span class="p">(</span><span class="o">**</span><span class="n">eps_jax</span><span class="p">)</span>
        <span class="n">eps_medium</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxCustomMedium</span><span class="p">(</span><span class="n">eps_dataset</span><span class="o">=</span><span class="n">eps_dataset</span><span class="p">,</span> <span class="n">interp_method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxBox</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">dr_center_x</span><span class="p">,</span> <span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">dr_size_x</span><span class="p">,</span> <span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w_thick</span><span class="p">))</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">tda</span><span class="o">.</span><span class="n">JaxStructure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">eps_medium</span><span class="p">)]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Creation of a CustomMedium using the values of the design parameters.</span>
        <span class="n">coords_y</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">dr_size_y</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">ls_grid_size</span> <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny_phi</span><span class="p">)]</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coords_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coords_y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">])</span>
        <span class="n">eps_jax</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">"eps_</span><span class="si">{</span><span class="n">dim</span><span class="si">}{</span><span class="n">dim</span><span class="si">}</span><span class="s2">"</span><span class="p">:</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxDataArray</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">eps_val</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="s2">"xyz"</span>
        <span class="p">}</span>
        <span class="n">eps_dataset</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxPermittivityDataset</span><span class="p">(</span><span class="o">**</span><span class="n">eps_jax</span><span class="p">)</span>
        <span class="n">eps_medium</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxCustomMedium</span><span class="p">(</span>
            <span class="n">eps_dataset</span><span class="o">=</span><span class="n">eps_dataset</span><span class="p">,</span> <span class="n">interp_method</span><span class="o">=</span><span class="s2">"linear"</span>
        <span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxBox</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">dr_center_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">dr_size_x</span><span class="p">,</span> <span class="n">dr_size_y</span><span class="p">,</span> <span class="n">w_thick</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="p">[</span><span class="n">tda</span><span class="o">.</span><span class="n">JaxStructure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">eps_medium</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">structure</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Initial-Structure">Initial Structure<a class="anchor-link" href="#Initial-Structure">¶</a></h2><p>We built an initial y-brach structure containing some holes and different gap sizes to demonstrate how the design evolves under fabrication constraints. We define this structure using a <code>PolySlab</code> object and then translate it into a permittivity grid of the same size as the one used to define the level set function. The holes are introduced in the polygon using the <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.ClipOperation.html" target="_blank">ClipOperation</a> object.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span><span class="p">,</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">0.75</span><span class="p">,</span>  <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_width</span><span class="p">),</span>                
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_width</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>        
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.3</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">6</span><span class="p">),</span> 
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">6</span><span class="p">),</span> 
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">6</span><span class="p">),</span>                               
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.3</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">6</span><span class="p">),</span>       
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>                 
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>                
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w_width</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w_width</span><span class="p">),</span>                
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>        
        <span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span><span class="p">,</span> <span class="o">-</span><span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">y_poly</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="p">(</span>
    <span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">w_thick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w_thick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">y_hole1</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">1.7</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                   <span class="n">radius</span><span class="o">=</span><span class="n">min_feature_size</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">w_thick</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_hole2</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">1.7</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                   <span class="n">radius</span><span class="o">=</span><span class="n">min_feature_size</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">w_thick</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_hole3</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.3</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                   <span class="n">radius</span><span class="o">=</span><span class="n">min_feature_size</span><span class="o">/</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">w_thick</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_hole4</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="mf">2.3</span><span class="o">*</span><span class="n">dr_size_x</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="n">w_gap</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                   <span class="n">radius</span><span class="o">=</span><span class="n">min_feature_size</span><span class="o">/</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">w_thick</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">init_design</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ClipOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">"difference"</span><span class="p">,</span> <span class="n">geometry_a</span><span class="o">=</span><span class="n">y_poly</span><span class="p">,</span> <span class="n">geometry_b</span><span class="o">=</span><span class="n">y_hole1</span><span class="p">)</span>
<span class="n">init_design</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ClipOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">"difference"</span><span class="p">,</span> <span class="n">geometry_a</span><span class="o">=</span><span class="n">init_design</span><span class="p">,</span> <span class="n">geometry_b</span><span class="o">=</span><span class="n">y_hole2</span><span class="p">)</span>
<span class="n">init_design</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ClipOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">"difference"</span><span class="p">,</span> <span class="n">geometry_a</span><span class="o">=</span><span class="n">init_design</span><span class="p">,</span> <span class="n">geometry_b</span><span class="o">=</span><span class="n">y_hole3</span><span class="p">)</span>
<span class="n">init_design</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ClipOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">"difference"</span><span class="p">,</span> <span class="n">geometry_a</span><span class="o">=</span><span class="n">init_design</span><span class="p">,</span> <span class="n">geometry_b</span><span class="o">=</span><span class="n">y_hole4</span><span class="p">)</span>

<span class="n">init_eps</span> <span class="o">=</span> <span class="n">init_design</span><span class="o">.</span><span class="n">inside_meshgrid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_phi</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_phi</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">init_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">init_eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps_max</span>

<span class="n">init_design</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_2.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Then an objective function which compares the initial structure and the permittivity distribution generated by the level set zero contour is defined.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Figure of Merit (FOM) calculation.</span>
<span class="k">def</span> <span class="nf">fom_eps</span><span class="p">(</span><span class="n">eps_ref</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the L2 norm between eps_ref and eps."""</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eps_ref</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Objective function to be passed to the optimization algorithm.</span>
<span class="k">def</span> <span class="nf">obj_eps</span><span class="p">(</span><span class="n">design_param</span><span class="p">,</span> <span class="n">eps_ref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">mirror_param</span><span class="p">(</span><span class="n">design_param</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">get_eps</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fom_eps</span><span class="p">(</span><span class="n">eps_ref</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>

<span class="c1"># Function to calculate the objective function value and its</span>
<span class="c1"># gradient with respect to the design parameters.</span>
<span class="n">obj_grad_eps</span> <span class="o">=</span> <span class="n">value_and_grad</span><span class="p">(</span><span class="n">obj_eps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>So, the initial control knots are obtained after fitting the initial structure using the level set function. This is accomplished by minimizing the L2 norm between the reference and the level set generated permittivities. The fitting is performed by the Adam optimizer from the <a href="https://optax.readthedocs.io/en/latest/index.html" target="_blank">Optax</a> library.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Initialize adam optimizer with starting parameters.</span>
<span class="n">start_par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npar</span><span class="p">))</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">start_par</span><span class="p">)</span>

<span class="c1"># Store history</span>
<span class="n">params_eps</span> <span class="o">=</span> <span class="n">start_par</span>
<span class="n">obj_eps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">params_history_eps</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_par</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>

    <span class="c1"># Compute gradient and current objective funciton value.</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">obj_grad_eps</span><span class="p">(</span><span class="n">params_eps</span><span class="p">,</span> <span class="n">init_eps</span><span class="p">)</span>

    <span class="c1"># outputs</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Step = </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">obj_eps = </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">grad_norm = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Compute and apply updates to the optimizer based on gradient.</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">params_eps</span><span class="p">)</span>
    <span class="n">params_eps</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">params_eps</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>

    <span class="c1"># Save history.</span>
    <span class="n">obj_eps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">params_history_eps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_eps</span><span class="p">)</span>

<span class="c1"># Gets the final parameters and the objective values history.</span>
<span class="n">init_rho</span> <span class="o">=</span> <span class="n">params_history_eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">obj_vals_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_eps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>WARNING:jax._src.xla_bridge:An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Step = 1
	obj_eps = 3.6687e+01
	grad_norm = 4.2700e+01
Step = 2
	obj_eps = 3.6697e+00
	grad_norm = 3.2333e+00
Step = 3
	obj_eps = 2.4378e+00
	grad_norm = 1.8882e+00
Step = 4
	obj_eps = 2.1341e+00
	grad_norm = 1.6315e+00
Step = 5
	obj_eps = 1.9714e+00
	grad_norm = 1.3847e+00
Step = 6
	obj_eps = 1.7556e+00
	grad_norm = 1.1197e+00
Step = 7
	obj_eps = 1.5511e+00
	grad_norm = 8.4940e-01
Step = 8
	obj_eps = 1.4104e+00
	grad_norm = 7.0775e-01
Step = 9
	obj_eps = 1.3275e+00
	grad_norm = 6.5512e-01
Step = 10
	obj_eps = 1.2859e+00
	grad_norm = 6.4978e-01
Step = 11
	obj_eps = 1.2632e+00
	grad_norm = 6.6684e-01
Step = 12
	obj_eps = 1.2370e+00
	grad_norm = 6.5305e-01
Step = 13
	obj_eps = 1.2016e+00
	grad_norm = 6.0398e-01
Step = 14
	obj_eps = 1.1636e+00
	grad_norm = 5.5132e-01
Step = 15
	obj_eps = 1.1264e+00
	grad_norm = 5.0319e-01
Step = 16
	obj_eps = 1.0915e+00
	grad_norm = 4.5089e-01
Step = 17
	obj_eps = 1.0631e+00
	grad_norm = 4.0192e-01
Step = 18
	obj_eps = 1.0442e+00
	grad_norm = 3.7285e-01
Step = 19
	obj_eps = 1.0339e+00
	grad_norm = 3.7258e-01
Step = 20
	obj_eps = 1.0277e+00
	grad_norm = 3.7846e-01
Step = 21
	obj_eps = 1.0218e+00
	grad_norm = 3.7785e-01
Step = 22
	obj_eps = 1.0135e+00
	grad_norm = 3.6398e-01
Step = 23
	obj_eps = 1.0019e+00
	grad_norm = 3.2941e-01
Step = 24
	obj_eps = 9.8984e-01
	grad_norm = 2.8871e-01
Step = 25
	obj_eps = 9.8045e-01
	grad_norm = 2.7301e-01
Step = 26
	obj_eps = 9.7357e-01
	grad_norm = 2.7771e-01
Step = 27
	obj_eps = 9.6689e-01
	grad_norm = 2.7823e-01
Step = 28
	obj_eps = 9.5920e-01
	grad_norm = 2.6414e-01
Step = 29
	obj_eps = 9.5129e-01
	grad_norm = 2.3818e-01
Step = 30
	obj_eps = 9.4490e-01
	grad_norm = 2.1175e-01
Step = 31
	obj_eps = 9.4123e-01
	grad_norm = 1.9891e-01
Step = 32
	obj_eps = 9.3983e-01
	grad_norm = 2.0254e-01
Step = 33
	obj_eps = 9.3895e-01
	grad_norm = 2.1227e-01
Step = 34
	obj_eps = 9.3670e-01
	grad_norm = 2.1269e-01
Step = 35
	obj_eps = 9.3249e-01
	grad_norm = 1.9599e-01
Step = 36
	obj_eps = 9.2750e-01
	grad_norm = 1.6543e-01
Step = 37
	obj_eps = 9.2375e-01
	grad_norm = 1.3975e-01
Step = 38
	obj_eps = 9.2225e-01
	grad_norm = 1.4069e-01
Step = 39
	obj_eps = 9.2201e-01
	grad_norm = 1.5765e-01
Step = 40
	obj_eps = 9.2120e-01
	grad_norm = 1.6748e-01
Step = 41
	obj_eps = 9.1871e-01
	grad_norm = 1.5993e-01
Step = 42
	obj_eps = 9.1492e-01
	grad_norm = 1.3628e-01
Step = 43
	obj_eps = 9.1127e-01
	grad_norm = 1.0882e-01
Step = 44
	obj_eps = 9.0900e-01
	grad_norm = 9.8597e-02
Step = 45
	obj_eps = 9.0808e-01
	grad_norm = 1.0754e-01
Step = 46
	obj_eps = 9.0756e-01
	grad_norm = 1.1597e-01
Step = 47
	obj_eps = 9.0665e-01
	grad_norm = 1.1322e-01
Step = 48
	obj_eps = 9.0525e-01
	grad_norm = 1.0168e-01
Step = 49
	obj_eps = 9.0381e-01
	grad_norm = 9.0192e-02
Step = 50
	obj_eps = 9.0269e-01
	grad_norm = 8.7089e-02
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>The following graph shows the evolution of the objective function along the initial structure fitting.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[10]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_vals_eps</span><span class="p">,</span> <span class="s2">"ro"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"iterations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"objective function"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Level Set Fit: Obj = </span><span class="si">{</span><span class="n">obj_vals_eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_3.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Here, one can see the initial parameters, which are the control knots defining the level set surface. The geometry of the structure will change as the zero isocontour evolves. The width of the Gaussian radial basis functions and the spacing of the control knots impact the accuracy and the smoothness of the initial zero-level set contour.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">eps_fit</span> <span class="o">=</span> <span class="n">get_eps</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">init_rho</span><span class="p">),</span> <span class="n">plot_levelset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_4.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Inverse-Design-Optimization-Set-Up">Inverse Design Optimization Set Up<a class="anchor-link" href="#Inverse-Design-Optimization-Set-Up">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Next, we will write a function to return the <code>JaxSimulation</code> object. Note that we are using a <code>MeshOverrideStructure</code> to obtain a uniform mesh over the design region.</p>
<p>The elements that do not change along the optimization are defined first.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Input waveguide.</span>
<span class="n">wg_input</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
        <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">eff_inf</span><span class="p">,</span> <span class="o">-</span><span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">w_thick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">w_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w_thick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">mat_si</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Output bends.</span>
<span class="n">x_start</span> <span class="o">=</span> <span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">w_length</span> <span class="o">+</span> <span class="n">dr_size_x</span> <span class="o">-</span> <span class="n">grid_size</span> <span class="c1"># x-coordinate of the starting point of the waveguide bends.</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
    <span class="n">x_start</span><span class="p">,</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">bend_length</span><span class="p">,</span> <span class="mi">100</span>
<span class="p">)</span>  <span class="c1"># x-coordinates of the top edge vertices.</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_start</span><span class="p">)</span> <span class="o">*</span> <span class="n">bend_offset</span> <span class="o">/</span> <span class="n">bend_length</span>
    <span class="o">-</span> <span class="n">bend_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">bend_length</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="p">(</span><span class="n">w_gap</span> <span class="o">+</span> <span class="n">w_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="p">)</span>  <span class="c1"># y coordinates of the top edge vertices</span>

<span class="c1"># adding the last point to include the straight waveguide at the output</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eff_inf</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># add path to the cell</span>
<span class="n">cell</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">"bend"</span><span class="p">)</span>
<span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">w_width</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Top waveguide bend.</span>
<span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">w_width</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Bottom waveguide bend.</span>

<span class="c1"># Define top waveguide bend structure.</span>
<span class="n">wg_bend_top</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="o">.</span><span class="n">from_gds</span><span class="p">(</span>
        <span class="n">cell</span><span class="p">,</span>
        <span class="n">gds_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">w_thick</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">w_thick</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">mat_si</span>
<span class="p">)</span>

<span class="c1"># Define bottom waveguide bend structure.</span>
<span class="n">wg_bend_bot</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">PolySlab</span><span class="o">.</span><span class="n">from_gds</span><span class="p">(</span>
        <span class="n">cell</span><span class="p">,</span>
        <span class="n">gds_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">w_thick</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">w_thick</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">medium</span><span class="o">=</span><span class="n">mat_si</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Monitors used to get simulation data.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[13]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Input mode source.</span>
<span class="n">mode_spec</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSpec</span><span class="p">(</span><span class="n">num_modes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">target_neff</span><span class="o">=</span><span class="n">nSi</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSource</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mon_w</span><span class="p">,</span> <span class="n">mon_h</span><span class="p">),</span>
    <span class="n">source_time</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GaussianPulse</span><span class="p">(</span><span class="n">freq0</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">fwidth</span><span class="o">=</span><span class="n">freqw</span><span class="p">),</span>
    <span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span>
    <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
    <span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Monitor where we will compute the objective function from.</span>
<span class="n">fom_monitor_1</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeMonitor</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="p">(</span><span class="n">w_gap</span> <span class="o">+</span> <span class="n">w_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bend_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mon_w</span><span class="p">,</span> <span class="n">mon_h</span><span class="p">],</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
    <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="n">fom_name_1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">### Monitors used only to visualize the initial and final y-branch results.</span>
<span class="c1"># Field monitors to visualize the final fields.</span>
<span class="n">field_xy</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"field_xy"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Monitor where we will compute the objective function from.</span>
<span class="n">fom_final_1</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeMonitor</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="n">size_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wl</span><span class="p">,</span> <span class="p">(</span><span class="n">w_gap</span> <span class="o">+</span> <span class="n">w_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bend_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mon_w</span><span class="p">,</span> <span class="n">mon_h</span><span class="p">],</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
    <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"out_1"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>And then the <code>JaxSimulation</code> is built.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[14]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_adjoint_sim</span><span class="p">(</span><span class="n">design_param</span><span class="p">,</span> <span class="n">unfold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxSimulation</span><span class="p">:</span>
    <span class="c1"># Builds the design region from the design parameters.</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">get_eps</span><span class="p">(</span><span class="n">design_param</span><span class="p">)</span>
    <span class="n">design_structure</span> <span class="o">=</span> <span class="n">update_design</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">unfold</span><span class="o">=</span><span class="n">unfold</span><span class="p">)</span>

    <span class="c1"># Creates a uniform mesh for the design region.</span>
    <span class="n">adjoint_dr_mesh</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">MeshOverrideStructure</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">dr_center_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">dr_size_x</span><span class="p">,</span> <span class="n">dr_size_y</span><span class="p">,</span> <span class="n">w_thick</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dl</span><span class="o">=</span><span class="p">[</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">],</span>
        <span class="n">enforce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxSimulation</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">size_z</span><span class="p">],</span>
        <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">grid_spec</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GridSpec</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="o">=</span><span class="n">wl_max</span><span class="p">,</span>
            <span class="n">min_steps_per_wvl</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">override_structures</span><span class="o">=</span><span class="p">[</span><span class="n">adjoint_dr_mesh</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">symmetry</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">structures</span><span class="o">=</span><span class="p">[</span><span class="n">wg_input</span><span class="p">,</span> <span class="n">wg_bend_top</span><span class="p">,</span> <span class="n">wg_bend_bot</span><span class="p">],</span>
        <span class="n">input_structures</span><span class="o">=</span><span class="n">design_structure</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">source</span><span class="p">],</span>
        <span class="n">monitors</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">output_monitors</span><span class="o">=</span><span class="p">[</span><span class="n">fom_monitor_1</span><span class="p">],</span>
        <span class="n">run_time</span><span class="o">=</span><span class="n">run_time</span><span class="p">,</span>
        <span class="n">subpixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Let's visualize the simulation setup and verify if all the elements are in their correct places. Differently from the density-based methods, we will start from a fully binarized structure.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">init_design</span> <span class="o">=</span> <span class="n">make_adjoint_sim</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">init_rho</span><span class="p">),</span> <span class="n">unfold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">init_design</span><span class="o">.</span><span class="n">plot_eps</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_5.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Now, we will run a simulation to see how this non-optimized y-branch performs.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[16]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_init</span> <span class="o">=</span> <span class="n">init_design</span><span class="o">.</span><span class="n">to_simulation</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
    <span class="n">update</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="p">(</span><span class="n">field_xy</span><span class="p">,</span> <span class="n">fom_final_1</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">sim_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sim_init</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s2">"initial y-branch"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:51:39 -03 </span>Created task <span style="color: #008000; text-decoration-color: #008000">'initial y-branch'</span> with task_id                       
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><span style="color: #008000; text-decoration-color: #008000">'fdve-16c3d2c7-da47-465a-98cf-ea2532dc3ca8'</span> and task_type <span style="color: #008000; text-decoration-color: #008000">'FDTD'</span>.  
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>View task using web UI at                                          
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da47-465a-98cf-ea2532dc3ca8" target="_blank"><span style="color: #008000; text-decoration-color: #008000">'https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da4</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da47-465a-98cf-ea2532dc3ca8" target="_blank"><span style="color: #008000; text-decoration-color: #008000">7-465a-98cf-ea2532dc3ca8'</span></a>.                                         
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:51:44 -03 </span>status = queued                                                    
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:51:55 -03 </span>status = preprocess                                                
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:02 -03 </span>Maximum FlexCredit cost: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.025</span>. Use <span style="color: #008000; text-decoration-color: #008000">'web.real_cost(task_id)'</span> to get
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>the billed FlexCredit cost after a simulation run.                 
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>starting up solver                                                 
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:03 -03 </span>running solver                                                     
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>To cancel the simulation, use <span style="color: #008000; text-decoration-color: #008000">'web.abort(task_id)'</span> or              
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><span style="color: #008000; text-decoration-color: #008000">'web.delete(task_id)'</span> or abort/delete the task in the web UI.      
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>Terminating the Python script will not stop the job running on the 
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>cloud.                                                             
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:17 -03 </span>early shutoff detected at <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">88</span>%, exiting.                            
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>status = postprocess                                               
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:21 -03 </span>status = success                                                   
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:22 -03 </span>View simulation result at                                          
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da47-465a-98cf-ea2532dc3ca8" target="_blank"><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">'https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da4</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-16c3d2c7-da47-465a-98cf-ea2532dc3ca8" target="_blank"><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">7-465a-98cf-ea2532dc3ca8'</span></a><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">.</span>                                         
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:52:25 -03 </span>loading simulation from simulation_data.hdf5                       
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>We will use the insertion loss (IL) to compare the device response before and after the optimization. Since we will use symmetry about the <code>y</code>-axis, the insertion loss is calculated as $IL = -10 log(2P_{1}/P_{in})$, where $P_{1}$ is the power coupled into the upper s-bend and $P_{in}$ is the unit input power. The insertion loss of the non-optimized y-branch is above 3 dB at 1.55 $\mu m$. From the field distribution image, we can realize that it happens because much of the input power is reflected.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">coeffs_f</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">"out_1"</span><span class="p">]</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">)</span>
<span class="n">power_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeffs_f</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">power_1_db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">power_1</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_range</span><span class="p">,</span> <span class="n">power_1_db</span><span class="p">,</span> <span class="s2">"-k"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength (um)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Power (dB)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wl</span> <span class="o">-</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wl</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Insertion Loss"</span><span class="p">)</span>
<span class="n">sim_data</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"field_xy"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="s2">"abs^2"</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_6.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Fabrication-Constraints">Fabrication Constraints<a class="anchor-link" href="#Fabrication-Constraints">¶</a></h2><p>Fabrication constraints are introduced in the optimization as penalty terms to control the minimum gap ($f_{g}$) and radius of curvature ($f_{c}$) in the final design. Below, we use <code>jax</code> to define the penalty terms following the formulation presented in <code>D. Vercruysse, N. V. Sapra, L. Su, R. Trivedi, and J. Vučković, "Analytical level set fabrication constraints for inverse design," Scientific Reports 9, 8999 (2019).</code> <a href="https://doi.org/10.1038/s41598-019-45026-0" target="_blank">DOI: 10.1038/s41598-019-45026-0</a>. The gap penalty function controls the minimum feature size by limiting the second derivative based on the value of the function at that point. The curvature constraint is only relevant at the device boundary, where $\phi = 0$, so we apply the smoothed Heaviside function to the level set surface before calculating the derivatives.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[18]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Auxiliary function to calculate first and second order partial derivatives.</span>
<span class="k">def</span> <span class="nf">ls_derivatives</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">d_size</span><span class="p">):</span>
    <span class="n">SC</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="n">phi_1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">d_size</span><span class="p">)</span>
    <span class="n">phi_x</span> <span class="o">=</span> <span class="n">phi_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">SC</span>
    <span class="n">phi_y</span> <span class="o">=</span> <span class="n">phi_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">SC</span>
    <span class="n">phi_2x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">phi_x</span><span class="p">,</span> <span class="n">d_size</span><span class="p">)</span>
    <span class="n">phi_2y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">phi_y</span><span class="p">,</span> <span class="n">d_size</span><span class="p">)</span>
    <span class="n">phi_xx</span> <span class="o">=</span> <span class="n">phi_2x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">phi_xy</span> <span class="o">=</span> <span class="n">phi_2x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">phi_yy</span> <span class="o">=</span> <span class="n">phi_2y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">phi_x</span><span class="p">,</span> <span class="n">phi_y</span><span class="p">,</span> <span class="n">phi_xx</span><span class="p">,</span> <span class="n">phi_xy</span><span class="p">,</span> <span class="n">phi_yy</span>    

<span class="c1"># Minimum gap size fabrication constraint integrand calculation. </span>
<span class="c1"># The "beta" parameter relax the constraint near the zero plane.</span>
<span class="k">def</span> <span class="nf">fab_penalty_ls_gap</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> 
                       <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                       <span class="n">min_feature_size</span><span class="o">=</span><span class="n">min_feature_size</span><span class="p">,</span> 
                       <span class="n">grid_size</span><span class="o">=</span><span class="n">ls_grid_size</span><span class="p">):</span>
    
    <span class="c1"># Get the level set surface.</span>
    <span class="n">phi_model</span> <span class="o">=</span> <span class="n">LevelSetInterp</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">x_rho</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">y_rho</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">rho_size</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_model</span><span class="o">.</span><span class="n">get_ls</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">x_phi</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">y_phi</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="p">(</span><span class="n">nx_phi</span><span class="p">,</span> <span class="n">ny_phi</span><span class="p">))</span>
    
    <span class="c1"># Calculates their derivatives.</span>
    <span class="n">phi_x</span><span class="p">,</span> <span class="n">phi_y</span><span class="p">,</span> <span class="n">phi_xx</span><span class="p">,</span> <span class="n">phi_xy</span><span class="p">,</span> <span class="n">phi_yy</span> <span class="o">=</span> <span class="n">ls_derivatives</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span>    

    <span class="c1"># Calculates the gap penalty over the level set grid.</span>
    <span class="n">pi_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.3</span> <span class="o">*</span> <span class="n">min_feature_size</span><span class="p">)</span>
    <span class="n">phi_v</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">phi_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">phi_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1e-32</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">phi_vv</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_xx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_x</span> <span class="o">*</span> <span class="n">phi_y</span> <span class="o">*</span> <span class="n">phi_xy</span> <span class="o">+</span> <span class="n">phi_y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_yy</span><span class="p">)</span> <span class="o">/</span> <span class="n">phi_v</span> <span class="o">**</span> <span class="mi">2</span>                 
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_vv</span><span class="p">)</span> <span class="o">/</span> 
                      <span class="p">(</span><span class="n">pi_d</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">phi_v</span><span class="p">)</span> <span class="o">-</span> <span class="n">pi_d</span><span class="p">)</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Minimum radius of curvature fabrication constraint integrand calculation.</span>
<span class="c1"># The "alpha" parameter controls its relative weight to the gap penalty.</span>
<span class="c1"># The "sharpness" parameter controls the smoothness of the surface near the zero-contour.</span>
<span class="k">def</span> <span class="nf">fab_penalty_ls_curve</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> 
                         <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">sharpness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                         <span class="n">min_feature_size</span><span class="o">=</span><span class="n">min_feature_size</span><span class="p">,</span> 
                         <span class="n">grid_size</span><span class="o">=</span><span class="n">ls_grid_size</span><span class="p">):</span>
    
    <span class="c1"># Get the permittivity surface and calculates their derivatives.</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">get_eps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">sharpness</span> <span class="o">=</span> <span class="n">sharpness</span><span class="p">)</span>
    <span class="n">eps_x</span><span class="p">,</span> <span class="n">eps_y</span><span class="p">,</span> <span class="n">eps_xx</span><span class="p">,</span> <span class="n">eps_xy</span><span class="p">,</span> <span class="n">eps_yy</span> <span class="o">=</span> <span class="n">ls_derivatives</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span> 

    <span class="c1"># Calculates the curvature penalty over the permittivity grid.   </span>
    <span class="n">pi_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">min_feature_size</span><span class="p">)</span>
    <span class="n">eps_v</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">eps_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1e-32</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eps_yy</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eps_x</span> <span class="o">*</span> <span class="n">eps_y</span> <span class="o">*</span> <span class="n">eps_xy</span> <span class="o">+</span> <span class="n">eps_y</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eps_xx</span><span class="p">)</span> <span class="o">/</span> <span class="n">eps_v</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">curve_const</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">eps_v</span> <span class="o">/</span> <span class="n">eps</span><span class="p">))</span> <span class="o">-</span> <span class="n">pi_d</span>
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">curve_const</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Gap and curvature fabrication constraints calculation.</span>
<span class="c1"># Penalty values are normalized by "norm_gap" and "norm_curve".</span>
<span class="k">def</span> <span class="nf">fab_penalty_ls</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> 
                   <span class="n">beta</span><span class="o">=</span><span class="n">gap_par</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="n">curve_par</span><span class="p">,</span>
                   <span class="n">sharpness</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                   <span class="n">min_feature_size</span><span class="o">=</span><span class="n">min_feature_size</span><span class="p">,</span> 
                   <span class="n">grid_size</span><span class="o">=</span><span class="n">ls_grid_size</span><span class="p">,</span>
                   <span class="n">norm_gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">norm_curve</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    
    <span class="c1"># Get the gap penalty fabrication constraint value.</span>
    <span class="n">gap_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_gap</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> 
                                         <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> 
                                         <span class="n">min_feature_size</span><span class="o">=</span><span class="n">min_feature_size</span><span class="p">,</span> 
                                         <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">gap_penalty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">gap_penalty_int</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_gap</span>

    <span class="c1"># Get the curvature penalty fabrication constraint value.</span>
    <span class="n">curve_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_curve</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> 
                                             <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                             <span class="n">sharpness</span><span class="o">=</span><span class="n">sharpness</span><span class="p">,</span> 
                                             <span class="n">min_feature_size</span><span class="o">=</span><span class="n">min_feature_size</span><span class="p">,</span> 
                                             <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">curve_penalty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">curve_penalty_int</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_curve</span>
    
    <span class="k">return</span> <span class="n">gap_penalty</span><span class="p">,</span> <span class="n">curve_penalty</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Now, we will calculate the initial penalty function values and observe the regions of the initial design that violate the constraints. The gap and curvature penalty functions are normalized by their initial values along the optimization to better balance the weights of device response and fabrication penalty within the objective function.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[19]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Initial values of gap and curvature fabrication constraints.</span>
<span class="n">init_fab_gap</span><span class="p">,</span> <span class="n">init_fab_curve</span> <span class="o">=</span> <span class="n">fab_penalty_ls</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">init_rho</span><span class="p">))</span>

<span class="c1"># Visualization of gap and curvature fabrication constraints values.</span>
<span class="n">gap_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_gap</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">init_rho</span><span class="p">),</span> <span class="n">beta</span><span class="o">=</span><span class="n">gap_par</span><span class="p">)</span>
<span class="n">curve_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_curve</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">init_rho</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">curve_par</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_phi</span><span class="p">,</span> <span class="n">x_phi</span><span class="p">)</span>    

<span class="n">im</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">gap_penalty_int</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gnuplot2_r'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">eps_fit</span><span class="p">,</span> <span class="p">[(</span><span class="n">eps_min</span> <span class="o">+</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Gap Penalty = </span><span class="si">{</span><span class="n">init_fab_gap</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>   
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">shrink</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> 

<span class="n">im</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">curve_penalty_int</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gnuplot2_r'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">eps_fit</span><span class="p">,</span> <span class="p">[(</span><span class="n">eps_min</span> <span class="o">+</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Curve Penalty = </span><span class="si">{</span><span class="n">init_fab_curve</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>   
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">shrink</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_7.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Running-the-Optimization">Running the Optimization<a class="anchor-link" href="#Running-the-Optimization">¶</a></h2><p>The figure-of-merit used in the y-branch optimization is the power ($P_{1, 2}$) coupled into the fundamental transverse electric mode of the output waveguides. We will set mirror symmetry about the <code>y</code>-axis in the optimization, so we must include only $P_{1}$ in the figure-of-merit. As we are using a minimization strategy, the coupled power and fabrication constraints are arranged within the objective function as $|0.5 - P_{1}| + w_{f} \times (f_{g} + f_{c})$, where $w_{f}$ is the fabrication constraint weight, whereas $f_{g}$ and $f_{c}$ are the gap and curvature penalty values.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[20]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Figure of Merit (FOM) calculation.</span>
<span class="k">def</span> <span class="nf">fom</span><span class="p">(</span><span class="n">sim_data</span><span class="p">:</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxSimulationData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the power at the mode index of interest."""</span>
    <span class="n">output_amps1</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">amps</span>
    <span class="n">amp1</span> <span class="o">=</span> <span class="n">output_amps1</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">eta1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amp1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">eta1</span><span class="p">),</span> <span class="n">eta1</span>

<span class="c1"># Objective function to be passed to the optimization algorithm.</span>
<span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="n">design_param</span><span class="p">,</span> <span class="n">fab_const</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">norm_gap</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">norm_curve</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">mirror_param</span><span class="p">(</span><span class="n">design_param</span><span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">make_adjoint_sim</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s2">"inv_des_ybranch"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">fom_val</span><span class="p">,</span> <span class="n">eta1</span> <span class="o">=</span> <span class="n">fom</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
    <span class="n">fab_gap</span><span class="p">,</span> <span class="n">fab_curve</span> <span class="o">=</span> <span class="n">fab_penalty_ls</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">norm_gap</span><span class="o">=</span><span class="n">norm_gap</span><span class="p">,</span> <span class="n">norm_curve</span><span class="o">=</span><span class="n">norm_curve</span><span class="p">)</span>    
    <span class="n">J</span> <span class="o">=</span> <span class="n">fom_val</span> <span class="o">+</span> <span class="n">fab_const</span> <span class="o">*</span> <span class="p">(</span><span class="n">fab_gap</span> <span class="o">+</span> <span class="n">fab_curve</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">J</span><span class="p">,</span> <span class="p">[</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">eta1</span><span class="p">,</span> <span class="n">fab_gap</span><span class="p">,</span> <span class="n">fab_curve</span><span class="p">]</span>

<span class="c1"># Function to calculate the objective function value and its</span>
<span class="c1"># gradient with respect to the design parameters.</span>
<span class="n">obj_grad</span> <span class="o">=</span> <span class="n">value_and_grad</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Optimizer initialization</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[21]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># where to store history</span>
<span class="n">history_fname</span> <span class="o">=</span> <span class="s2">"./misc/y_branch_fab.pkl"</span>

<span class="k">def</span> <span class="nf">save_history</span><span class="p">(</span><span class="n">history_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convenience function to save the history to file."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_fname</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">history_dict</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_history</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convenience method to load the history from file."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_fname</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">history_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">history_dict</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Before starting, we will look for data from a previous optimization.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[22]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Initialize adam optimizer with starting parameters.</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">history_dict</span> <span class="o">=</span> <span class="n">load_history</span><span class="p">()</span>
    <span class="n">opt_state</span> <span class="o">=</span> <span class="n">history_dict</span><span class="p">[</span><span class="s2">"opt_states"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">history_dict</span><span class="p">[</span><span class="s2">"params"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_iters_completed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"params"</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Loaded optimization checkpoint from file."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">"Found </span><span class="si">{</span><span class="n">num_iters_completed</span><span class="si">}</span><span class="s2"> iterations previously completed out of </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> total."</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">num_iters_completed</span> <span class="o">&lt;</span> <span class="n">iterations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Will resume optimization."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Optimization completed, will return results."</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init_rho</span><span class="p">)</span>
    <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">history_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">eta1</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">penalty_gap</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">penalty_curve</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">params</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">gradients</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">opt_states</span><span class="o">=</span><span class="p">[</span><span class="n">opt_state</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Loaded optimization checkpoint from file.
Found 100 iterations previously completed out of 100 total.
Optimization completed, will return results.
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Now, we are ready to run the optimization!</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[23]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">td</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="s2">"ERROR"</span>

<span class="n">iter_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"values"</span><span class="p">])</span>

<span class="k">if</span> <span class="n">iter_done</span> <span class="o">&lt;</span> <span class="n">iterations</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iter_done</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>

        <span class="c1"># Compute gradient and current objective function value.</span>
        <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">obj_grad</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fab_const</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">norm_gap</span><span class="o">=</span><span class="n">init_fab_gap</span><span class="p">,</span> <span class="n">norm_curve</span><span class="o">=</span><span class="n">init_fab_curve</span><span class="p">)</span>
        <span class="n">sim_data_i</span><span class="p">,</span> <span class="n">eta1</span><span class="p">,</span> <span class="n">penalty_gap</span><span class="p">,</span> <span class="n">penalty_curve</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="c1"># outputs</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Step = </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">obj_val = </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">grad_norm = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">eta1 = </span><span class="si">{</span><span class="n">eta1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">penalty gap = </span><span class="si">{</span><span class="n">penalty_gap</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">penalty curve = </span><span class="si">{</span><span class="n">penalty_curve</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Compute and apply updates to the optimizer based on gradient.</span>
        <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>

        <span class="c1"># Save history.</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"values"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"eta1"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eta1</span><span class="p">)</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"penalty_gap"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">penalty_gap</span><span class="p">)</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"penalty_curve"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">penalty_curve</span><span class="p">)</span>                
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"params"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"gradients"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
        <span class="n">history_dict</span><span class="p">[</span><span class="s2">"opt_states"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_state</span><span class="p">)</span>
        <span class="c1"># history_dict["data"].append(sim_data_i)  # Uncomment to store data, can create large files.</span>
        <span class="n">save_history</span><span class="p">(</span><span class="n">history_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[24]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">obj_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"values"</span><span class="p">])</span>
<span class="n">eta1_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"eta1"</span><span class="p">])</span>
<span class="n">pen_gap_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"penalty_gap"</span><span class="p">])</span>
<span class="n">pen_curve_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history_dict</span><span class="p">[</span><span class="s2">"penalty_curve"</span><span class="p">])</span>
<span class="n">final_par</span> <span class="o">=</span> <span class="n">history_dict</span><span class="p">[</span><span class="s2">"params"</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Optimization-Results">Optimization Results<a class="anchor-link" href="#Optimization-Results">¶</a></h3><p>Below, we can see how the device response and fabrication penalty have evolved throughout the optimization. The coupling into the output waveguide improves quickly in the beginning at the expense of higher penalty values. Then, the penalty values decrease linearly after the device response achieves a near-optimal condition. This trend results from the small weight factor we have chosen for the fabrication penalty terms.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[25]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_vals</span><span class="p">,</span> <span class="s2">"ko"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"objective"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eta1_vals</span><span class="p">,</span> <span class="s2">"bo"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"p_1"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen_gap_vals</span><span class="p">,</span> <span class="s2">"ro"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"gap"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen_curve_vals</span><span class="p">,</span> <span class="s2">"gs"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"curvature"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"iterations"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"objective function"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Final Objective Function Value: </span><span class="si">{</span><span class="n">obj_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_8.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>The optimization process obtained a smooth and well-defined geometry.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[26]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">eps_final</span> <span class="o">=</span> <span class="n">get_eps</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">final_par</span><span class="p">),</span> <span class="n">plot_levelset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_9.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>We can also see a significant reduction in violations to the minimum feature size after the optimization, which results in a smoother structure. The optimized device has not matched the minimum feature size exactly. The minimum radius of curvature and gap size are about 30% higher and 20% lower than the reference feature size, respectively. This deviation is expected, as reported in the previous paper. In this regard, running the simulation longer, adjusting the penalty weight or compensating for the reference feature size could improve the results.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[27]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Initial values of gap and curvature fabrication constraints.</span>
<span class="n">final_fab_gap</span><span class="p">,</span> <span class="n">final_fab_curve</span> <span class="o">=</span> <span class="n">fab_penalty_ls</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">final_par</span><span class="p">))</span>

<span class="c1"># Visualization of gap and curvature fabrication constraints values.</span>
<span class="n">gap_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_gap</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">final_par</span><span class="p">),</span> <span class="n">beta</span><span class="o">=</span><span class="n">gap_par</span><span class="p">)</span>
<span class="n">curve_penalty_int</span> <span class="o">=</span> <span class="n">fab_penalty_ls_curve</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">final_par</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">curve_par</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_phi</span><span class="p">,</span> <span class="n">x_phi</span><span class="p">)</span>    

<span class="n">im</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">gap_penalty_int</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gnuplot2_r'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">eps_final</span><span class="p">,</span> <span class="p">[(</span><span class="n">eps_min</span> <span class="o">+</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Gap Penalty = </span><span class="si">{</span><span class="n">final_fab_gap</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>   
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">shrink</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> 

<span class="n">im</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">curve_penalty_int</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gnuplot2_r'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">eps_final</span><span class="p">,</span> <span class="p">[(</span><span class="n">eps_min</span> <span class="o">+</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Curve Penalty = </span><span class="si">{</span><span class="n">final_fab_curve</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>   
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x ($\mu m$)"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y ($\mu m$)"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">shrink</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_10.png"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>Once the inverse design is complete, we can visualize the field distributions and the wavelength dependent insertion loss.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[28]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_final</span> <span class="o">=</span> <span class="n">make_adjoint_sim</span><span class="p">(</span><span class="n">mirror_param</span><span class="p">(</span><span class="n">final_par</span><span class="p">),</span> <span class="n">unfold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sim_final</span> <span class="o">=</span> <span class="n">sim_final</span><span class="o">.</span><span class="n">to_simulation</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="p">(</span><span class="n">field_xy</span><span class="p">,</span> <span class="n">fom_final_1</span><span class="p">)))</span>
<span class="n">sim_data_final</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sim_final</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s2">"inv_des_final"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:18 -03 </span>Created task <span style="color: #008000; text-decoration-color: #008000">'inv_des_final'</span> with task_id                          
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><span style="color: #008000; text-decoration-color: #008000">'fdve-3586e38c-80ea-46ba-a4ca-55ca76aa040a'</span> and task_type <span style="color: #008000; text-decoration-color: #008000">'FDTD'</span>.  
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>View task using web UI at                                          
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80ea-46ba-a4ca-55ca76aa040a" target="_blank"><span style="color: #008000; text-decoration-color: #008000">'https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80e</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80ea-46ba-a4ca-55ca76aa040a" target="_blank"><span style="color: #008000; text-decoration-color: #008000">a-46ba-a4ca-55ca76aa040a'</span></a>.                                         
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:22 -03 </span>status = queued                                                    
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:31 -03 </span>status = preprocess                                                
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:38 -03 </span>Maximum FlexCredit cost: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.025</span>. Use <span style="color: #008000; text-decoration-color: #008000">'web.real_cost(task_id)'</span> to get
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>the billed FlexCredit cost after a simulation run.                 
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>starting up solver                                                 
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>running solver                                                     
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>To cancel the simulation, use <span style="color: #008000; text-decoration-color: #008000">'web.abort(task_id)'</span> or              
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><span style="color: #008000; text-decoration-color: #008000">'web.delete(task_id)'</span> or abort/delete the task in the web UI.      
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>Terminating the Python script will not stop the job running on the 
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>cloud.                                                             
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:52 -03 </span>early shutoff detected at <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">96</span>%, exiting.                            
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>status = postprocess                                               
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:53:57 -03 </span>status = success                                                   
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span>View simulation result at                                          
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80ea-46ba-a4ca-55ca76aa040a" target="_blank"><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">'https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80e</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">             </span><a href="https://tidy3d.simulation.cloud/workbench?taskId=fdve-3586e38c-80ea-46ba-a4ca-55ca76aa040a" target="_blank"><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">a-46ba-a4ca-55ca76aa040a'</span></a><span style="color: #000080; text-decoration-color: #000080; text-decoration: underline">.</span>                                         
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Output()</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html" tabindex="0">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">09:54:01 -03 </span>loading simulation from simulation_data.hdf5                       
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p>The resulting structure shows good performance, presenting insertion loss of only 0.1 dB near the central wavelength.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">[29]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">mode_amps</span> <span class="o">=</span> <span class="n">sim_data_final</span><span class="p">[</span><span class="s2">"out_1"</span><span class="p">]</span>
<span class="n">coeffs_f</span> <span class="o">=</span> <span class="n">mode_amps</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">)</span>
<span class="n">power_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeffs_f</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">power_1_db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">power_1</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sim_final</span><span class="o">.</span><span class="n">plot_eps</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">source_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">monitor_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl_range</span><span class="p">,</span> <span class="n">power_1_db</span><span class="p">,</span> <span class="s2">"-k"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength (um)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Power (dB)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wl</span> <span class="o">-</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wl</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Insertion Loss"</span><span class="p">)</span>
<span class="n">sim_data_final</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s2">"field_xy"</span><span class="p">,</span> <span class="s2">"E"</span><span class="p">,</span> <span class="s2">"abs^2"</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_vals</span><span class="p">,</span> <span class="s2">"ko"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"objective"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eta1_vals</span><span class="p">,</span> <span class="s2">"bo"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"p_1"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen_gap_vals</span><span class="p">,</span> <span class="s2">"ro"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"gap"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen_curve_vals</span><span class="p">,</span> <span class="s2">"gs"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"curvature"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"iterations"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"objective function"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Final Objective Function Value: </span><span class="si">{</span><span class="n">obj_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
<img alt="No description has been provided for this image" class="" src="/assets/tidy3d/examples/image/AdjointPlugin10YBranchLevelSet/AdjointPlugin10YBranchLevelSet_11.png"/>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
