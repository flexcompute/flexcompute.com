<html>
<head><meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <link href="/assets/tidy3d/examples/css/example-notebook.css" rel="stylesheet"/>
  <title>Tutorial5</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>

  <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
  <script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
      const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
      // do not load mermaidjs if not needed
      if (!diagrams.length) {
        return;
      }
      const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.esm.min.mjs")).default;

      mermaid.initialize({
        maxTextSize: 100000,
        startOnLoad: false,
        fontFamily: window
          .getComputedStyle(document.body)
          .getPropertyValue("--jp-ui-font-family"),
        theme: document.querySelector("body[data-jp-theme-light='true']")
          ? "default"
          : "dark",
      });

      let _nextMermaidId = 0;

      function makeMermaidImage(svg) {
        const img = document.createElement('img');
        const maxWidth = svg.match(/max-width: (\d+)/);
        if (maxWidth && maxWidth[1]) {
          const width = parseInt(maxWidth[1]);
          if (width && !Number.isNaN(width) && Number.isFinite(width)) {
            img.width = width;
          }
        }
        img.setAttribute('src', `data:image/svg+xml,${encodeURIComponent(svg)}`);
        return img;
      }

      async function makeMermaidError(text) {
        let errorMessage = '';
        try {
          await mermaid.parse(text);
        } catch (err) {
          errorMessage = `${err}`;
        }

        const result = document.createElement('details');
        const summary = document.createElement('summary');
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.innerText = text;
        pre.appendChild(code);
        summary.appendChild(pre);
        result.appendChild(summary);

        const warning = document.createElement('pre');
        warning.innerText = errorMessage;
        result.appendChild(warning);
        return result;
      }

      async function renderOneMarmaid(src) {
        const id = `jp-mermaid-${_nextMermaidId++}`;
        const parent = src.parentNode;
        let raw = src.textContent.trim();
        const el = document.createElement("div");
        el.style.visibility = "hidden";
        document.body.appendChild(el);
        let result = null;
        try {
          const { svg } = await mermaid.render(id, raw, el);
          result = makeMermaidImage(svg);
        } catch (err) {
          parent.classList.add("jp-mod-warning");
          result = await makeMermaidError(raw);
        } finally {
          el.remove();
        }
        parent.classList.add("jp-RenderedMermaid");
        parent.appendChild(result);
      }

      void Promise.all([...diagrams].map(renderOneMarmaid));
    });
  </script>
  <style>
      .jp-RenderedMarkdown .jp-Mermaid:not(.jp-RenderedMermaid) {
          display: none;
      }
      .jp-RenderedMarkdown .jp-RenderedMermaid.jp-mod-warning {
          width: auto;
          padding: 10px;
          border: var(--jp-border-width) solid var(--jp-warn-color2);
          border-radius: var(--jp-border-radius);
          color: var(--jp-ui-font-color1);
          font-size: var(--jp-ui-font-size1);
          white-space: pre-wrap;
          word-wrap: break-word;
      }
      .jp-RenderedMarkdown .jp-RenderedMermaid.jp-mod-warning details > pre {
          margin-top: 1em;
      }
      .jp-RenderedMarkdown .jp-RenderedMermaid.jp-mod-warning summary {
          color: var(--jp-warn-color2);
      }
      .jp-RenderedMarkdown .jp-RenderedMermaid.jp-mod-warning summary > pre {
          display: inline-block;
      }
      .jp-RenderedMermaid > .mermaid {
          display: none;
      }
  </style>
</head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=1535d9e4-b444-46e3-9a39-9d5a6ce1f724">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Adjoint-based-Shape-Optimization-of-a-Waveguide-Bend">Adjoint-based Shape Optimization of a Waveguide Bend<a class="anchor-link" href="#Adjoint-based-Shape-Optimization-of-a-Waveguide-Bend">¶</a></h2><p>In this notebook, we will apply the adjoint method to the optimization of a low-loss waveguide bend. We start with a 90 degree bend in a SiN waveguide, parameterized using a <code>td.PolySlab</code>.</p>
      <p>We define an objective function that seeks to maximize the transmission of the TE0 output mode amplitude with respect to the position of the polygon vertices defining the bend. A penalty is applied to keep the local radii of curvature larger than a pre-defined value.</p>
      <p>The resulting device demonstrates low loss and exhibits a smooth geometry.</p>
      <blockquote>
        <p>To install the <code>jax</code> module required for this feature, we recommend running <code>pip install "tidy3d[jax]"</code>.</p>
      </blockquote>
      <p>If you are unfamiliar with inverse design, we also recommend our <a href="https://www.flexcompute.com/tidy3d/learning-center/inverse-design/Lecture-1-Introduction-to-Inverse-Design-In-Photonics/">intro to inverse design tutorials</a> and our <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/AdjointPlugin1Intro/">primer on automatic differentiation with tidy3d</a>.</p>
      <h2 id="Setup">Setup<a class="anchor-link" href="#Setup">¶</a></h2><p>First, we import <code>tidy3d</code> and it's  <code>adjoint</code> plugin. We will also use <code>numpy</code>, <code>matplotlib</code> and <code>jax</code>.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=49188672-e1c3-43f1-92c0-a575810aa0ac">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tidy3d</span> <span class="k">as</span> <span class="nn">td</span>
<span class="kn">import</span> <span class="nn">tidy3d.plugins.adjoint</span> <span class="k">as</span> <span class="nn">tda</span>
<span class="kn">from</span> <span class="nn">tidy3d.plugins.adjoint.web</span> <span class="kn">import</span> <span class="n">run_local</span> <span class="k">as</span> <span class="n">run</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c3d77738-af2f-44d5-b329-d89c71c7c8d8">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [2]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4ae21094-7d43-41ff-8e1e-8ae793a42650">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ba08a4ef-c31c-41bc-bff7-922bf83a7b1e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next, we define all the global parameters for our device and optimization.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=330887eb-6c9a-4173-8b73-b7583c8c5869">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">wavelength</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">freq0</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">C_0</span> <span class="o">/</span> <span class="n">wavelength</span>

<span class="c1"># frequency of measurement and source</span>
<span class="c1"># note: we only optimize results at the central frequency for now.</span>
<span class="n">fwidth</span> <span class="o">=</span> <span class="n">freq0</span> <span class="o">/</span> <span class="mi">10</span>
<span class="n">num_freqs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">freq0</span> <span class="o">-</span> <span class="n">fwidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq0</span> <span class="o">+</span> <span class="n">fwidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_freqs</span><span class="p">)</span>

<span class="c1"># define the discretization of the bend polygon in angle</span>
<span class="n">num_pts</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_pts</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># refractive indices of waveguide and substrate (air above)</span>
<span class="n">n_wg</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">n_sub</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="c1"># min space between waveguide and PML</span>
<span class="n">spc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">wavelength</span>

<span class="c1"># length of input and output straight waveguide sections</span>
<span class="n">t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">wavelength</span>

<span class="c1"># distance between PML and the mode source / mode monitor</span>
<span class="n">mode_spc</span> <span class="o">=</span> <span class="n">t</span> <span class="o">/</span> <span class="mf">2.0</span>

<span class="c1"># height of waveguide core</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="c1"># minimum, starting, and maximum allowed thicknesses for the bend geometry</span>
<span class="n">wmin</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">wmid</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">wmax</span> <span class="o">=</span> <span class="mf">2.5</span>

<span class="c1"># average radius of curvature of the bend</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># minimum allowed radius of curvature of the polygon</span>
<span class="n">min_radius</span> <span class="o">=</span> <span class="mf">150e-3</span>

<span class="c1"># name of the monitor measuring the transmission amplitudes for optimization</span>
<span class="n">monitor_name</span> <span class="o">=</span> <span class="s2">"mode"</span>

<span class="c1"># how many grid points per wavelength in the waveguide core material</span>
<span class="n">min_steps_per_wvl</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># how many mode outputs to measure</span>
<span class="n">num_modes</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mode_spec</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSpec</span><span class="p">(</span><span class="n">num_modes</span><span class="o">=</span><span class="n">num_modes</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=491189f1-8d54-45d2-bd14-f0e46163cdc5">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Using all of these parameters, we can define the total simulation size.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=099d588f-6745-4db4-8ca0-452a498e6d2b">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [5]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">Lx</span> <span class="o">=</span> <span class="n">Ly</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wmax</span> <span class="o">-</span> <span class="n">wmid</span><span class="p">)</span> <span class="o">+</span> <span class="n">spc</span>
<span class="n">Lz</span> <span class="o">=</span> <span class="n">spc</span> <span class="o">+</span> <span class="n">h</span> <span class="o">+</span> <span class="n">spc</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=89afa716-793b-40ff-b762-2dfccf05c867">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h3 id="Define-parameterization">Define parameterization<a class="anchor-link" href="#Define-parameterization">¶</a></h3><p>Next we describe how the geometry looks as a function of our design parameters.</p>
      <p>At each angle on our bend discretization, we define a parameter that can range between -inf and +inf to control the thickness of that section. If that parameter is -inf, 0, and +inf, the thickness of that section is <code>wmin</code>, <code>wmid</code>, and <code>wmax</code>, respectively.</p>
      <p>This gives us a smooth way to constrain our measurable parameter without needing to worry about it in the optimization.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=104ab125-3ac9-4569-ab70-873acd41f0fc">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [6]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">thickness</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""thickness of a bend section as a function of a parameter in (-inf, +inf)."""</span>
    <span class="n">param_01</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">wmax</span> <span class="o">*</span> <span class="n">param_01</span> <span class="o">+</span> <span class="n">wmin</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">param_01</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7261fdc3-9520-4995-9610-1586d330ed13">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next we write a function to generate all of our bend polygon vertices given our array of design parameters. Note that we add extra vertices at the beginning and end of the bend that are <strong>independent</strong> of the parameters (static) and are only there to make it easier to connect the bend to the input and output waveguide sections.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f04524c0-9ac4-4990-a142-c3596323606d">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [7]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_vertices</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Make bend polygon vertices as a function of design parameters."""</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">))</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">thickness_i</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">radius_i</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">thickness_i</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">radius_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">radius_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span>
        <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">))</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-2</span><span class="p">))</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">angles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">thickness_i</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">radius_i</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">thickness_i</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">radius_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">radius_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span>
        <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">vertices</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3e5f676f-0e63-4e41-9df9-514afd08eb7e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's try out our <code>make_vertices</code> function on a set of all <code>0</code> parameters, which should give the starting waveguide width of <code>wmid</code> across the bend.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=580d21d7-6423-4299-b889-676294966565">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [8]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_pts</span><span class="p">)</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="n">make_vertices</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr">
<pre>No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
</pre>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cea18164-b71b-4fca-9d0e-801390531f9c">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [9]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">"equal"</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_1.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3b4df320-a42a-463c-9a9a-bcd84c7f7dd3">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Looks good, note again that the extra points on the ends are just to ensure a solid overlap with the in and out waveguides. At this time, the adjoint plugin does not handle polygons that extend outside of the simulation domain so we need to also ensure that all points are inside of the domain.</p>
      <p>Next we wrap this to write a function to generate a 3D <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxPolySlab.html">JaxPolySlab</a> geometry given our design parameters. The <code>JaxPolySlab</code> is simply a jax-compatible version of the regular <code>PolySlab</code> geometry that can be differentiated through.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=044f2377-62e8-4be8-9815-87cc1368d3ba">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [10]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_polyslab</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxPolySlab</span><span class="p">:</span>
    <span class="sd">"""Make a `tidy3d.PolySlab` for the bend given the design parameters."""</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">make_vertices</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxPolySlab</span><span class="p">(</span>
        <span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span>
        <span class="n">slab_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b57aa022-e979-4a19-9826-016ec22574ca">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's visualize this as well.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ea0df1fd-0c81-4185-9455-81c1a2af2a4a">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [11]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">polyslab</span> <span class="o">=</span> <span class="n">make_polyslab</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">polyslab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_2.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dc3b3303-3942-4004-a49b-f66fc07a0eb3">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Keeping with this theme, we add a function to generate a list of <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxStructure.html">JaxStructure</a>s with just one element (our differentiable polygon bend).</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8db1381a-dd4a-4e99-a207-6f1c1363d173">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [12]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_input_structures</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tda</span><span class="o">.</span><span class="n">JaxStructure</span><span class="p">]:</span>
    <span class="n">polyslab</span> <span class="o">=</span> <span class="n">make_polyslab</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">medium</span> <span class="o">=</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxMedium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_wg</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tda</span><span class="o">.</span><span class="n">JaxStructure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">polyslab</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">)]</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2ab62467-2ac4-4908-8344-2c342944f8e1">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [13]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">ring</span><span class="p">,)</span> <span class="o">=</span> <span class="n">input_structures</span> <span class="o">=</span> <span class="n">make_input_structures</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_3.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=92d145cd-20e9-4762-ba3b-227d667b3fcd">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next, we define the other "static" geometries, such as the input waveguide section, output waveguide section, and substrate.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=0e756863-4009-421a-9b86-20509d1d807b">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [14]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">box_in</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">box_out</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">wmid</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">geo_sub</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="n">rmin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mi">10000</span><span class="p">),</span>
    <span class="n">rmax</span><span class="o">=</span><span class="p">(</span><span class="o">+</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">+</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">wg_in</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">box_in</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_wg</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="n">wg_out</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">box_out</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_wg</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="n">substrate</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geo_sub</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">permittivity</span><span class="o">=</span><span class="n">n_sub</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=36c7b8fa-51fb-4852-9e62-f231410d8e0e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Fabrication-Constraints">Fabrication Constraints<a class="anchor-link" href="#Fabrication-Constraints">¶</a></h2><p>With the current parameterization, it is possible to generate structures with wildly varying radii of curvature which may be difficult to fabricate. To alleviate this, we introduce a minimum radius of curvature penalty transformation using the tidy3d adjoint utilities. The penalty will take a set of vertices, compute the local radius of curvature using a quadratic Bezier curve, and return an average penalty function that depends on how much smaller the local radii are compared to a desired minimum radius.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a4e9cb73-c8a9-41ec-a4e2-af2eac220c04">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [15]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tidy3d.plugins.adjoint.utils.penalty</span> <span class="kn">import</span> <span class="n">RadiusPenalty</span>

<span class="n">penalty</span> <span class="o">=</span> <span class="n">RadiusPenalty</span><span class="p">(</span><span class="n">min_radius</span><span class="o">=</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=557d4e5b-8441-433f-8965-e81c2f4b6231">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>We then wrap this penalty to look at only the inner and outer vertices independently and average the penalty from each.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4e4bc5d9-2c57-412c-8cc2-cc026b39857b">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [16]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">eval_penalty</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">"""Evaluate penalty on a set of params looking at radius of curvature."""</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">make_vertices</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">_vertices</span> <span class="o">=</span>  <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
    <span class="n">vertices_top</span> <span class="o">=</span> <span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">num_pts</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># select outer set of points along bend</span>
    <span class="n">vertices_bot</span> <span class="o">=</span> <span class="n">_vertices</span><span class="p">[</span><span class="n">num_pts</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span>  <span class="c1"># select inner set of points along bend</span>
    <span class="n">penalty_top</span> <span class="o">=</span> <span class="n">penalty</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">vertices_top</span><span class="p">)</span>
    <span class="n">penalty_bot</span> <span class="o">=</span> <span class="n">penalty</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">vertices_bot</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">penalty_top</span> <span class="o">+</span> <span class="n">penalty_bot</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=9881812c-1795-4f83-a24f-0b01833638e7">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's try this out on our starting parameters. We see we get a jax traced float that seems reasonably low given our smooth starting structure.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d13993be-d625-4537-af2a-f7700c199612">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [17]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">eval_penalty</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child jp-OutputArea-executeResult">
        <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[17]:</div>
        <div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
          <pre>Array(3.5788543e-23, dtype=float32)</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=28462443-1777-4b35-8c03-32490755f475">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Define-Simulation">Define Simulation<a class="anchor-link" href="#Define-Simulation">¶</a></h2><p>Now we define our sources, monitors, and simulation.</p>
      <p>We first define a mode source injected at the input waveguide.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=96cf199b-0a3b-4ace-9e1e-ba6c62d165f7">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [18]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">mode_width</span> <span class="o">=</span> <span class="n">wmid</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">spc</span>
<span class="n">mode_height</span> <span class="o">=</span> <span class="n">Lz</span>

<span class="n">mode_src</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeSource</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode_width</span><span class="p">,</span> <span class="n">mode_height</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">direction</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span>
    <span class="n">source_time</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GaussianPulse</span><span class="p">(</span>
        <span class="n">freq0</span><span class="o">=</span><span class="n">freq0</span><span class="p">,</span>
        <span class="n">fwidth</span><span class="o">=</span><span class="n">fwidth</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=79c7db54-87c6-4ba4-9da7-68ae176a222f">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next, we define monitors for storing:</p>
      <ul>
        <li><p>The output mode amplitude at the central frequency.</p>
        </li>
        <li><p>The flux on the output plane (for reference).</p>
        </li>
        <li><p>The output mode amplitude across a frequency range (for examining the transmission spectrum of our final device).</p>
        </li>
        <li><p>A field monitor to measure fields directly in the z-normal plane intersecting the waveguide.</p>
        </li>
      </ul>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=731f5f2f-0c38-4e86-add9-7ba8eea6c951">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [19]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">mode_mnt</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeMonitor</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">mode_width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_height</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="n">monitor_name</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq0</span><span class="p">],</span>
    <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">flux_mnt</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FluxMonitor</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">mode_width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_height</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"flux"</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq0</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">mode_mnt_bb</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">ModeMonitor</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">mode_width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_height</span><span class="p">),</span>
    <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="o">-</span><span class="n">Ly</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"mode_bb"</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fld_mnt</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">FieldMonitor</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">freq0</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"field"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">[22:01:59] </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Default value for the field monitor          </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/monitor.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">monitor.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/monitor.py#261" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">261</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'colocate'</span><span style="color: #800000; text-decoration-color: #800000"> setting has changed to </span><span style="color: #008000; text-decoration-color: #008000">'True'</span><span style="color: #800000; text-decoration-color: #800000"> in Tidy3D    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.4</span><span style="color: #800000; text-decoration-color: #800000">.</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #800000; text-decoration-color: #800000">. All field components will be colocated to the  </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">grid boundaries. Set to </span><span style="color: #008000; text-decoration-color: #008000">'False'</span><span style="color: #800000; text-decoration-color: #800000"> to get the raw fields </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">on the Yee grid instead.                              </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=2e47e54a-65f3-463f-b790-fd873597659e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next we put everything together into a function that returns a <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxSimulation.html">JaxSimulation</a> given our parameters and an optional boolean specifying whether to include the field monitor (to save data when fields are not required).</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f33bcf5e-2f31-4969-acb7-42bc06b1347e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [20]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_sim</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">use_fld_mnt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxSimulation</span><span class="p">:</span>
    <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_mnt_bb</span><span class="p">,</span> <span class="n">flux_mnt</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">use_fld_mnt</span><span class="p">:</span>
        <span class="n">monitors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fld_mnt</span><span class="p">]</span>
    <span class="n">input_structures</span> <span class="o">=</span> <span class="n">make_input_structures</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tda</span><span class="o">.</span><span class="n">JaxSimulation</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Lz</span><span class="p">),</span>
        <span class="n">input_structures</span><span class="o">=</span><span class="n">input_structures</span><span class="p">,</span>
        <span class="n">structures</span><span class="o">=</span><span class="p">[</span><span class="n">substrate</span><span class="p">,</span> <span class="n">wg_in</span><span class="p">,</span> <span class="n">wg_out</span><span class="p">],</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">mode_src</span><span class="p">],</span>
        <span class="n">output_monitors</span><span class="o">=</span><span class="p">[</span><span class="n">mode_mnt</span><span class="p">],</span>
        <span class="n">grid_spec</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">GridSpec</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="n">min_steps_per_wvl</span><span class="o">=</span><span class="n">min_steps_per_wvl</span><span class="p">),</span>
        <span class="n">boundary_spec</span><span class="o">=</span><span class="n">td</span><span class="o">.</span><span class="n">BoundarySpec</span><span class="o">.</span><span class="n">pml</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">,</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="n">fwidth</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c7d38368-afd9-4a29-864a-4c6c6385acea">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's try it out and plot our simulation.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=42fcce5a-11e9-4de2-b03e-97ca75af1628">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [21]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">make_sim</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">Lx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">t</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: </span><span style="color: #008000; text-decoration-color: #008000">'JaxPolySlab'</span><span style="color: #800000; text-decoration-color: #800000">-containing                  </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/plugins/adjoint/components/simulation.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">simulation.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/plugins/adjoint/components/simulation.py#202" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">202</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'JaxSimulation.input_structures[0]'</span><span style="color: #800000; text-decoration-color: #800000"> intersects with</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #008000; text-decoration-color: #008000">'JaxSimulation.structures[1]'</span><span style="color: #800000; text-decoration-color: #800000">. Note that in this   </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">version of the adjoint plugin, there may be errors </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">in the gradient when </span><span style="color: #008000; text-decoration-color: #008000">'JaxPolySlab'</span><span style="color: #800000; text-decoration-color: #800000"> intersects with </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">background structures.                             </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Suppressed </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="color: #800000; text-decoration-color: #800000"> WARNING message.                    </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">log.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py#130" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">130</span></a>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Structure at structures</span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">]</span><span style="color: #800000; text-decoration-color: #800000"> was detected as</span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/simulation.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">simulation.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/simulation.py#486" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">486</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">being less than half of a central wavelength from a</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">PML on side x-min. To avoid inaccurate results,    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">please increase gap between any structures and PML </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">or fully extend structure through the pml.         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Suppressed </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="color: #800000; text-decoration-color: #800000"> WARNING message.                    </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">log.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py#130" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">130</span></a>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Structure at structures</span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">]</span><span style="color: #800000; text-decoration-color: #800000"> was detected as</span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/simulation.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">simulation.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/components/simulation.py#486" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">486</span></a>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">being less than half of a central wavelength from a</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">PML on side x-min. To avoid inaccurate results,    </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">please increase gap between any structures and PML </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
<span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">or fully extend structure through the pml.         </span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                 </span>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output" data-mime-type="text/html">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">           </span><span style="color: #800000; text-decoration-color: #800000">WARNING: Suppressed </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="color: #800000; text-decoration-color: #800000"> WARNING message.                    </span> <a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">log.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/momchil/Drive/flexcompute/tidy3d-core/tidy3d_frontend/tidy3d/log.py#130" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">130</span></a>
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_4.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c4850a27-08e1-4267-8076-8d5b6ece9f8e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <blockquote>
        <p>Note: we get warnings from the adjoint plugin because the polyslab intersects the static waveguide ports and those edges will give inaccurate gradients. We can safely ignore those warnings because we don't need gradients with respect to them.</p>
      </blockquote>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fa5b961a-1b10-416d-9b68-c4d1d24d087a">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [22]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">td</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="s2">"ERROR"</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b11fca49-0b3f-4f96-9b2e-933b0c8ea6ac">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Select-the-desired-waveguide-mode">Select the desired waveguide mode<a class="anchor-link" href="#Select-the-desired-waveguide-mode">¶</a></h2><p>Next, we use the <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.mode.ModeSolver.html">ModeSolver</a> to solve and select the <code>mode_index</code> that gives us the proper injected and measured modes. We plot all of the fields for the first 3 modes and see that the TE0 mode is <code>mode_index=0</code>.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8480cca1-a8df-4c43-81d0-18b7ffa5076f">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [23]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tidy3d.plugins.mode</span> <span class="kn">import</span> <span class="n">ModeSolver</span>

<span class="n">ms</span> <span class="o">=</span> <span class="n">ModeSolver</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">plane</span><span class="o">=</span><span class="n">mode_src</span><span class="p">,</span> <span class="n">mode_spec</span><span class="o">=</span><span class="n">mode_spec</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">mode_mnt</span><span class="o">.</span><span class="n">freqs</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Effective index of computed modes: "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">n_eff</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_modes</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mode_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_modes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">field_ind</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s2">"Ex"</span><span class="p">,</span> <span class="s2">"Ey"</span><span class="p">,</span> <span class="s2">"Ez"</span><span class="p">)):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">field_components</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="n">mode_ind</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">mode_ind</span><span class="p">,</span> <span class="n">field_ind</span><span class="p">]</span>
        <span class="n">field</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'y'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'z'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'RdBu'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">, mode_ind=</span><span class="si">{</span><span class="n">mode_ind</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>Effective index of computed modes:  [[1.7966835 1.7514163 1.6002883]]
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_5.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a9fe1aaf-5e75-445a-80a5-e7a75197a8ee">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Since this is already the default mode index, we can leave the original <code>make_sim()</code> function as is. However, to generate a new mode source with a different <code>mode_index</code>, we could do the following and rewrite that function with the returned <code>mode_src</code>.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5e1974b0-28c8-4d65-9d79-976cb012b870">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [24]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="c1"># select the mode index</span>
<span class="n">mode_index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># make the mode source with appropriate mode index</span>
<span class="n">mode_src</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">mode_index</span><span class="o">=</span><span class="n">mode_index</span><span class="p">,</span> <span class="n">source_time</span><span class="o">=</span><span class="n">mode_src</span><span class="o">.</span><span class="n">source_time</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">mode_src</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ab0e3e8c-3336-4fa3-9eca-6e89e0c50812">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Defining-objective-function">Defining objective function<a class="anchor-link" href="#Defining-objective-function">¶</a></h2><p>Now we can define our objective function to maximize. The objective function first generates a simulation given the parameters, runs the simulation using the <code>jax</code>-compatible <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.web.run.html">tidy3d.plugins.adjoint.run</a> function, measures the power transmitted into the TE0 output mode at our desired polarization, and then subtracts the radius of curvature penalty that we defined earlier.</p>
      <p>For convenience, we also return the <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxSimulationData.html">JaxSimulationData</a> as the 2nd output, which will be ignored by <code>jax</code> when we pass <code>has_aux=True</code> when computing the gradient of this function.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9f02432c-1de7-45da-ac8d-dc730093acff">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [25]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">use_fld_mnt</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">make_sim</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">use_fld_mnt</span><span class="o">=</span><span class="n">use_fld_mnt</span><span class="p">)</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'bend'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">amps</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="n">monitor_name</span><span class="p">]</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"-"</span><span class="p">,</span> <span class="n">mode_index</span><span class="o">=</span><span class="n">mode_index</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">transmission</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amps</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">transmission</span><span class="p">)</span> <span class="o">-</span> <span class="n">eval_penalty</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">J</span><span class="p">,</span> <span class="n">sim_data</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8e82ef72-d130-48dd-b88d-bdc5e5ccde0f">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next, we use <a href="https://jax.readthedocs.io/en/latest/_autosummary/jax.value_and_grad.html">jax.value_and_grad</a> to transform this objective function into a function that returns the</p>
      <ul>
        <li><p>Objective function evaluated at the passed parameters.</p>
        </li>
        <li><p>Auxilary <a href="https://docs.flexcompute.com/projects/tidy3d/en/latest/_autosummary/tidy3d.plugins.adjoint.JaxSimulationData.html">JaxSimulationData</a> corresponding to the forward pass (for plotting later).</p>
        </li>
        <li><p>Gradient of the objective function with respect to the passed parameters.</p>
        </li>
      </ul>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d8390c85-0506-4a4f-aa85-fa9311a969bd">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [26]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">val_grad</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a1cad86d-800f-40c8-8966-d2483cdd254e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's run this function and take a look at the outputs.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=99393577-a86b-4d20-98b2-8e45b4b88058">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [27]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">),</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">val_grad</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0adcb4f4-8b8d-4526-bfcd-5be2caf810c2">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [28]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>0.5606048
[-0.01883917 -0.02968327 -0.04119704 -0.05332555 -0.0657288  -0.07819955
 -0.09031129 -0.10045863 -0.11044198 -0.11628526 -0.11940013 -0.11855873
 -0.11367789 -0.10428579 -0.09043597 -0.07393086 -0.05485675 -0.03374749
 -0.01146651  0.01097884  0.03232303  0.0521329   0.07017162  0.08563211
  0.09907499  0.10945182  0.11626573  0.12678576  0.11849307  0.12726338
  0.12726587  0.11850015  0.12679777  0.11628053  0.10946865  0.0990923
  0.08564843  0.07018599  0.05214434  0.03233124  0.01098366 -0.01146469
 -0.03374784 -0.0548588  -0.07393336 -0.09043836 -0.10428729 -0.11367796
 -0.11855777 -0.11939806 -0.11628282 -0.11043957 -0.10045616 -0.09030911
 -0.07819756 -0.06572723 -0.05332468 -0.04119653 -0.02968323 -0.01883924]
</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6aea9708-fe5c-4f9e-aae3-0d4aa769fa17">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>These seem reasonable and can now be used for plugging into our optimization algorithm.</p>
      <h2 id="Optimization-Procedure">Optimization Procedure<a class="anchor-link" href="#Optimization-Procedure">¶</a></h2><p>With our gradients defined, we write a simple optimization loop using the <a href="https://optax.readthedocs.io/en/latest/">optax</a> package. We use the <code>adam</code> method with a tunable number of steps and learning rate. The intermediate values, parameters, and data are stored for visualization later.</p>
      <blockquote>
        <p>Note: this will take several minutes. While not shown here, it is good practice to checkpoint your optimization results by saving to file on every iteration, or ensure you have a stable internet connection. See <a href="https://www.flexcompute.com/tidy3d/examples/notebooks/AdjointPlugin6GratingCoupler/">this notebook</a> for more details.</p>
      </blockquote>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f0a6b1e7-6d87-483e-a54e-ac8ca19a03fa">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [29]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">optax</span>

<span class="c1"># hyperparameters</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># initialize adam optimizer with starting parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># store history</span>
<span class="n">objective_history</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">param_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">]</span>
<span class="n">data_history</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>

    <span class="c1"># compute gradient and current objective funciton value</span>
    <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">),</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">val_grad</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># multiply all by -1 to maximize obj_fn</span>
    <span class="n">gradient</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="c1"># outputs</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"step = </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">J = </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">grad_norm = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># compute and apply updates to the optimizer based on gradient</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>

    <span class="c1"># save history</span>
    <span class="n">objective_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">param_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">data_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>step = 1
	J = 5.6060e-01
	grad_norm = 6.7526e-01
step = 2
	J = 8.4790e-01
	grad_norm = 4.8040e-01
step = 3
	J = 8.9985e-01
	grad_norm = 4.0505e-01
step = 4
	J = 8.5131e-01
	grad_norm = 5.0348e-01
step = 5
	J = 8.3506e-01
	grad_norm = 4.8749e-01
step = 6
	J = 8.6678e-01
	grad_norm = 4.8803e-01
step = 7
	J = 9.2224e-01
	grad_norm = 3.5351e-01
step = 8
	J = 9.5242e-01
	grad_norm = 1.8946e-01
step = 9
	J = 9.4218e-01
	grad_norm = 2.4269e-01
step = 10
	J = 9.1947e-01
	grad_norm = 2.9453e-01
step = 11
	J = 9.0531e-01
	grad_norm = 3.2005e-01
step = 12
	J = 9.1071e-01
	grad_norm = 3.1154e-01
step = 13
	J = 9.3085e-01
	grad_norm = 2.5689e-01
step = 14
	J = 9.5300e-01
	grad_norm = 1.7606e-01
step = 15
	J = 9.6490e-01
	grad_norm = 1.0440e-01
step = 16
	J = 9.6218e-01
	grad_norm = 1.3483e-01
step = 17
	J = 9.5238e-01
	grad_norm = 1.9516e-01
step = 18
	J = 9.4548e-01
	grad_norm = 2.2601e-01
step = 19
	J = 9.4680e-01
	grad_norm = 2.1709e-01
step = 20
	J = 9.5441e-01
	grad_norm = 1.7686e-01
step = 21
	J = 9.6259e-01
	grad_norm = 1.2697e-01
step = 22
	J = 9.6678e-01
	grad_norm = 9.8830e-02
step = 23
	J = 9.6526e-01
	grad_norm = 1.2304e-01
step = 24
	J = 9.6185e-01
	grad_norm = 1.4719e-01
step = 25
	J = 9.5993e-01
	grad_norm = 1.5421e-01
step = 26
	J = 9.6063e-01
	grad_norm = 1.4313e-01
step = 27
	J = 9.6385e-01
	grad_norm = 1.2455e-01
step = 28
	J = 9.6807e-01
	grad_norm = 1.0047e-01
step = 29
	J = 9.7131e-01
	grad_norm = 7.4751e-02
step = 30
	J = 9.7191e-01
	grad_norm = 6.6567e-02
step = 31
	J = 9.7001e-01
	grad_norm = 8.9463e-02
step = 32
	J = 9.6791e-01
	grad_norm = 1.0970e-01
step = 33
	J = 9.6786e-01
	grad_norm = 1.1280e-01
step = 34
	J = 9.7046e-01
	grad_norm = 9.2556e-02
step = 35
	J = 9.7376e-01
	grad_norm = 5.5497e-02
step = 36
	J = 9.7541e-01
	grad_norm = 2.5039e-02
step = 37
	J = 9.7487e-01
	grad_norm = 4.3832e-02
step = 38
	J = 9.7340e-01
	grad_norm = 6.8956e-02
step = 39
	J = 9.7261e-01
	grad_norm = 7.9948e-02
step = 40
	J = 9.7334e-01
	grad_norm = 7.4701e-02
</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=9760808f-512b-4806-85b6-809ba15e389c">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Analyzing-results">Analyzing results<a class="anchor-link" href="#Analyzing-results">¶</a></h2><p>After the optimization is finished, let's look at the results.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=09aac45c-d7d8-4fd1-a599-0a7888257120">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [30]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objective_history</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'iteration number'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'objective function'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'optimization progress'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_6.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=bdbff561-b56c-4e83-8841-3c1ea7d5ba9e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Next, we can grab our initial and final device from the history lists.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d782b925-2af0-4bb8-bf87-88526a3f359f">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [31]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">sim_start</span> <span class="o">=</span> <span class="n">make_sim</span><span class="p">(</span><span class="n">param_history</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">data_start</span> <span class="o">=</span> <span class="n">data_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">sim_final</span> <span class="o">=</span> <span class="n">make_sim</span><span class="p">(</span><span class="n">param_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data_final</span> <span class="o">=</span> <span class="n">data_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=63a876ae-1d19-4f38-a958-170c9576b21a">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's take a look at the final structure. We see that it has a smooth design which is symmetric about the 45 degree angle.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7ec2b20e-74de-4b82-949f-591696437315">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [32]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sim_final</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_7.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=95b503b9-a29e-455c-aef3-e4a97a0c59b2">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Now let's inspect the difference between the initial and final intensity patterns. We notice that the final device is quite effective at coupling light into the output waveguide! This is especially evident when compared to the starting device.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a2dddafd-8cee-42fd-a1c7-ddc94f4ef9e8">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [33]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">data_start</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s1">'field'</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">,</span> <span class="s1">'abs^2'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sim_start</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'starting device'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'starting device'</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">data_final</span><span class="o">.</span><span class="n">plot_field</span><span class="p">(</span><span class="s1">'field'</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">,</span> <span class="s1">'abs^2'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sim_final</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'final device'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'final device'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_8.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=38997828-6ea8-489c-96b0-3cb4aae502c2">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Let's view the transmission now, both in linear and dB scale.</p>
      <p>The mode amplitudes are simply an <a href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.html">xarray.DataArray</a> that can be selected, post processed, and plotted.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9075ae74-7b0a-4336-98a6-0b89a650d0d3">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [34]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">amps</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s1">'mode_bb'</span><span class="p">]</span><span class="o">.</span><span class="n">amps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">"-"</span><span class="p">,</span> <span class="n">mode_index</span><span class="o">=</span><span class="n">mode_index</span><span class="p">)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=93a9b8e8-7581-4fb3-a3f4-f718a80082d0">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [35]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">transmission</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">transmission_percent</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">transmission</span>
<span class="n">transmission_percent</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"f"</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'mode_index=0, transmitted power %'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'T (%)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_9.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d3e0d5af-c8b5-4e02-8955-c1701b5c454e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>We can also put this in log scale.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=53fa2b4f-7b59-4318-9510-8df38ae7d1a2">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [36]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">transmission</span>
<span class="n">loss_db</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">transmission</span><span class="p">)</span>
<span class="n">loss_db</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"f"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'loss (dB)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedImage jp-OutputArea-output">
          <img loading="eager" class="jp-needs-light-background" src="/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_10.png"/>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ed3f4cd4-fe66-4320-962d-e91d40faefe7">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Finally, let's animate the field pattern evolution over the entire optimization. This will take a minute or so.</p>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fd145f1b-74f9-432b-9f9c-71ac61944568">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [37]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>

    <span class="c1"># grab data at iteration "i"</span>
    <span class="n">sim_data_i</span> <span class="o">=</span> <span class="n">data_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># plot permittivity</span>
    <span class="n">sim_i</span> <span class="o">=</span> <span class="n">sim_data_i</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">to_simulation</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sim_i</span><span class="o">.</span><span class="n">plot_eps</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">monitor_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">source_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="c1"># ax1.set_aspect('equal')</span>

    <span class="c1"># plot intensity</span>
    <span class="n">int_i</span> <span class="o">=</span> <span class="n">sim_data_i</span><span class="o">.</span><span class="n">get_intensity</span><span class="p">(</span><span class="s2">"field"</span><span class="p">)</span>
    <span class="n">int_i</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'y'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"magma"</span><span class="p">)</span>
    <span class="c1"># ax2.set_aspect('equal')</span>

<span class="c1"># create animation</span>
<span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_history</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># display the animation (press "play" to start)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child jp-OutputArea-executeResult">
        <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[37]:</div>
        <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html">
          <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet"/>
          <script language="javascript">
            function isInternetExplorer() {
              ua = navigator.userAgent;
              /* MSIE used to detect old browsers and Trident used to newer ones*/
              return ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
            }

            /* Define the Animation class */
            function Animation(frames, img_id, slider_id, interval, loop_select_id){
              this.img_id = img_id;
              this.slider_id = slider_id;
              this.loop_select_id = loop_select_id;
              this.interval = interval;
              this.current_frame = 0;
              this.direction = 0;
              this.timer = null;
              this.frames = new Array(frames.length);

              for (var i=0; i<frames.length; i++)
              {
                this.frames[i] = new Image();
                this.frames[i].src = frames[i];
              }
              var slider = document.getElementById(this.slider_id);
              slider.max = this.frames.length - 1;
              if (isInternetExplorer()) {
                // switch from oninput to onchange because IE <= 11 does not conform
                // with W3C specification. It ignores oninput and onchange behaves
                // like oninput. In contrast, Microsoft Edge behaves correctly.
                slider.setAttribute('onchange', slider.getAttribute('oninput'));
                slider.setAttribute('oninput', null);
              }
              this.set_frame(this.current_frame);
            }

            Animation.prototype.get_loop_state = function(){
              var button_group = document[this.loop_select_id].state;
              for (var i = 0; i < button_group.length; i++) {
                var button = button_group[i];
                if (button.checked) {
                  return button.value;
                }
              }
              return undefined;
            }

            Animation.prototype.set_frame = function(frame){
              this.current_frame = frame;
              document.getElementById(this.img_id).src =
                this.frames[this.current_frame].src;
              document.getElementById(this.slider_id).value = this.current_frame;
            }

            Animation.prototype.next_frame = function()
            {
              this.set_frame(Math.min(this.frames.length - 1, this.current_frame + 1));
            }

            Animation.prototype.previous_frame = function()
            {
              this.set_frame(Math.max(0, this.current_frame - 1));
            }

            Animation.prototype.first_frame = function()
            {
              this.set_frame(0);
            }

            Animation.prototype.last_frame = function()
            {
              this.set_frame(this.frames.length - 1);
            }

            Animation.prototype.slower = function()
            {
              this.interval /= 0.7;
              if(this.direction > 0){this.play_animation();}
              else if(this.direction < 0){this.reverse_animation();}
            }

            Animation.prototype.faster = function()
            {
              this.interval *= 0.7;
              if(this.direction > 0){this.play_animation();}
              else if(this.direction < 0){this.reverse_animation();}
            }

            Animation.prototype.anim_step_forward = function()
            {
              this.current_frame += 1;
              if(this.current_frame < this.frames.length){
                this.set_frame(this.current_frame);
              }else{
                var loop_state = this.get_loop_state();
                if(loop_state == "loop"){
                  this.first_frame();
                }else if(loop_state == "reflect"){
                  this.last_frame();
                  this.reverse_animation();
                }else{
                  this.pause_animation();
                  this.last_frame();
                }
              }
            }

            Animation.prototype.anim_step_reverse = function()
            {
              this.current_frame -= 1;
              if(this.current_frame >= 0){
                this.set_frame(this.current_frame);
              }else{
                var loop_state = this.get_loop_state();
                if(loop_state == "loop"){
                  this.last_frame();
                }else if(loop_state == "reflect"){
                  this.first_frame();
                  this.play_animation();
                }else{
                  this.pause_animation();
                  this.first_frame();
                }
              }
            }

            Animation.prototype.pause_animation = function()
            {
              this.direction = 0;
              if (this.timer){
                clearInterval(this.timer);
                this.timer = null;
              }
            }

            Animation.prototype.play_animation = function()
            {
              this.pause_animation();
              this.direction = 1;
              var t = this;
              if (!this.timer) this.timer = setInterval(function() {
                t.anim_step_forward();
              }, this.interval);
            }

            Animation.prototype.reverse_animation = function()
            {
              this.pause_animation();
              this.direction = -1;
              var t = this;
              if (!this.timer) this.timer = setInterval(function() {
                t.anim_step_reverse();
              }, this.interval);
            }
          </script>
          <style>
              .animation {
                  display: inline-block;
                  text-align: center;
              }
              input[type=range].anim-slider {
                  width: 374px;
                  margin-left: auto;
                  margin-right: auto;
              }
              .anim-buttons {
                  margin: 8px 0px;
              }
              .anim-buttons button {
                  padding: 0;
                  width: 36px;
              }
              .anim-state label {
                  margin-right: 8px;
              }
              .anim-state input {
                  margin: 0;
                  vertical-align: middle;
              }
          </style>
          <div class="animation">
            <img loading="eager" id="_anim_img62ff88f2ebb74c44baf432a839f2389a"/>
            <div class="anim-controls">
              <input class="anim-slider" id="_anim_slider62ff88f2ebb74c44baf432a839f2389a" max="1" min="0" name="points" oninput="anim62ff88f2ebb74c44baf432a839f2389a.set_frame(parseInt(this.value));" step="1" type="range" value="0"/>
              <div class="anim-buttons">
                <button aria-label="Decrease speed" onclick="anim62ff88f2ebb74c44baf432a839f2389a.slower()" title="Decrease speed">
                  <i class="fa fa-minus"></i></button>
                <button aria-label="First frame" onclick="anim62ff88f2ebb74c44baf432a839f2389a.first_frame()" title="First frame">
                  <i class="fa fa-fast-backward"></i></button>
                <button aria-label="Previous frame" onclick="anim62ff88f2ebb74c44baf432a839f2389a.previous_frame()" title="Previous frame">
                  <i class="fa fa-step-backward"></i></button>
                <button aria-label="Play backwards" onclick="anim62ff88f2ebb74c44baf432a839f2389a.reverse_animation()" title="Play backwards">
                  <i class="fa fa-play fa-flip-horizontal"></i></button>
                <button aria-label="Pause" onclick="anim62ff88f2ebb74c44baf432a839f2389a.pause_animation()" title="Pause">
                  <i class="fa fa-pause"></i></button>
                <button aria-label="Play" onclick="anim62ff88f2ebb74c44baf432a839f2389a.play_animation()" title="Play">
                  <i class="fa fa-play"></i></button>
                <button aria-label="Next frame" onclick="anim62ff88f2ebb74c44baf432a839f2389a.next_frame()" title="Next frame">
                  <i class="fa fa-step-forward"></i></button>
                <button aria-label="Last frame" onclick="anim62ff88f2ebb74c44baf432a839f2389a.last_frame()" title="Last frame">
                  <i class="fa fa-fast-forward"></i></button>
                <button aria-label="Increase speed" onclick="anim62ff88f2ebb74c44baf432a839f2389a.faster()" title="Increase speed">
                  <i class="fa fa-plus"></i></button>
              </div>
              <form action="#n" aria-label="Repetition mode" class="anim-state" name="_anim_loop_select62ff88f2ebb74c44baf432a839f2389a" title="Repetition mode">
                <input id="_anim_radio1_62ff88f2ebb74c44baf432a839f2389a" name="state" type="radio" value="once"/>
                <label for="_anim_radio1_62ff88f2ebb74c44baf432a839f2389a">Once</label>
                <input checked="" id="_anim_radio2_62ff88f2ebb74c44baf432a839f2389a" name="state" type="radio" value="loop"/>
                <label for="_anim_radio2_62ff88f2ebb74c44baf432a839f2389a">Loop</label>
                <input id="_anim_radio3_62ff88f2ebb74c44baf432a839f2389a" name="state" type="radio" value="reflect"/>
                <label for="_anim_radio3_62ff88f2ebb74c44baf432a839f2389a">Reflect</label>
              </form>
            </div>
          </div>
          <script language="javascript">
            /* Instantiate the Animation class. */
            /* The IDs given should match those used in the template above. */
            (function() {
              var img_id = "_anim_img62ff88f2ebb74c44baf432a839f2389a";
              var slider_id = "_anim_slider62ff88f2ebb74c44baf432a839f2389a";
              var loop_select_id = "_anim_loop_select62ff88f2ebb74c44baf432a839f2389a";
              var frames = new Array(40);

              frames[0] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_1.png"
              frames[1] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_2.png"
              frames[2] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_3.png"
              frames[3] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_4.png"
              frames[4] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_5.png"
              frames[5] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_6.png"
              frames[6] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_7.png"
              frames[7] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_8.png"
              frames[8] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_9.png"
              frames[9] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_10.png"
              frames[10] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_11.png"
              frames[11] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_12.png"
              frames[12] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_13.png"
              frames[13] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_14.png"
              frames[14] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_15.png"
              frames[15] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_16.png"
              frames[16] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_17.png"
              frames[17] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_18.png"
              frames[18] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_19.png"
              frames[19] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_20.png"
              frames[20] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_21.png"
              frames[21] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_22.png"
              frames[22] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_23.png"
              frames[23] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_24.png"
              frames[24] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_25.png"
              frames[25] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_26.png"
              frames[26] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_27.png"
              frames[27] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_28.png"
              frames[28] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_29.png"
              frames[29] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_30.png"
              frames[30] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_31.png"
              frames[31] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_32.png"
              frames[32] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_33.png"
              frames[33] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_34.png"
              frames[34] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_35.png"
              frames[35] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_36.png"
              frames[36] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_37.png"
              frames[37] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_38.png"
              frames[38] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_39.png"
              frames[39] = "/assets/images/inverse-design/Lecture_05/Python_Tutorial_05_extra_40.png"


              /* set a timeout to make sure all the above elements are created before
                 the object is initialized. */
              setTimeout(function() {
                anim62ff88f2ebb74c44baf432a839f2389a = new Animation(frames, img_id, slider_id, 200.0,
                  loop_select_id);
              }, 0);
            })()
          </script>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
          <pre>&lt;Figure size 432x288 with 0 Axes&gt;</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8b94076e-345e-41b5-a122-1a9da5495e40">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
    </div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <blockquote>
        <p>To save the animation to file, uncomment the line below. Will take a few minutes to render.</p>
      </blockquote>
    </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3728bfe3-12f2-479b-9f5a-f0068530171b">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [39]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ani.save('animation_bend_adjoint.gif', fps=60)</span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr">
<pre>MovieWriter ffmpeg unavailable; using Pillow instead.
</pre>
        </div>
      </div>
      <div class="jp-OutputArea-child">
        <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
        <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
          <pre>&lt;Figure size 432x288 with 0 Axes&gt;</pre>
        </div>
      </div>
    </div>
  </div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e6dc501b-54ef-4ef5-b54d-a45ce55af44e">
  <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
        <div class="CodeMirror cm-s-jupyter">
          <div class="highlight hl-ipython3"><pre><span></span>
</pre></div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
